<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIIS_AI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/konva/7.1.4/konva.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/js/all.min.js"></script>
    <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.2.0/build/ol.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.15.3/js/all.js"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.1.0/css/all.css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.2.0/css/ol.css"
        type="text/css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css">
    <!-- <link rel="stylesheet" type="text/css" href="css/base.css"> -->
    <link rel="stylesheet" type="text/css" href="css/painter.css">
    <link rel="stylesheet" type="text/css" href="css/font.css">
</head>

<body>
    <div class="confirm">
        <div class="confirmBox">
            <div>
                <div id="confirmMessage">
                    <div id="mainMessage"> </div>
                    <div id="secondMessage"></div>
                </div>
                <div> <button id="confirmYes" type="button" value="Yes">是</button> <button id="confirmNo" type="button"
                        value="No">否</button> </div>
            </div>
        </div>
    </div>
    <div class="main painter_BG">
        <div id="wait_img_load">
            <div class="lds-ripple">
                <div></div>
                <div></div>
            </div>
            <div>圖片檔載入中</div>
        </div>
        <div id="painter_app">
            <div id="painter_panel"></div>
        </div>
        <div class="tool_BG">
            <div class="menu"> <button class="icon-menu  img-fluid" type="button" title="工具清單" /> </div>
            <div class="toolbar">
                <div id="top">
                    <tbody>
                        <tr>
                            <td> <button class="point_btn toolbar_btn" type="button" title="選取" id="MouseMode"
                                    value="MouseMode" name="current-tool-mode"><i
                                        class="fas fa-mouse-pointer"></i></button> </td>
                        </tr>
                        <tr>
                            <td> <button class="pen_btn img-fluid toolbar_btn" type="button" title="筆畫工具"><img
                                        src="./img/icon/btn_pen.png" alt="" class="img-fluid"></button>
                                <div class="pen_d slide_right">
                                    <div class="" style="margin: 5px 8px 8px 10px; height: .8rem;">
                                        <div>標記形狀</div>
                                    </div>
                                    <div
                                        style="width: 100%;height: calc(100% - 1.5rem);overflow: auto;padding: 0 10px 0 10px">
                                        <div class="small mb-2">形狀選擇：</div>
                                        <button class="pen_btn_d" type="button" title="矩形工具" id="RectangleMode"
                                            value="RectangleMode" name="current-tool-mode">
                                            <img src="./img/icon/btn_pen_square.png" alt="" class="">
                                            <span style="font-size: 0.6rem">矩形工具</span>
                                        </button>
                                        <button class="pen_btn_d" type="button" title="圓形工具" id="EllipseMode"
                                            value="EllipseMode" name="current-tool-mode">
                                            <img src="./img/icon/btn_pen_circle.png" alt="" class="">
                                            <span style="font-size: 0.6rem">圓形工具</span>
                                        </button>
                                        <button class="pen_btn_d" type="button" title="多邊形工具" id="PolygonMode"
                                            value="PolygonMode" name="current-tool-mode">
                                            <img src="./img/icon/btn_pen_shape.png" alt="" class=""><span
                                                style="font-size: 0.6rem">多邊形工具</span>
                                        </button>
                                        <button class="pen_btn_d" type="button" title="不規則形工具" id="PencilMode"
                                            value="PencilMode" name="current-tool-mode" style="margin-bottom: 0.7rem">
                                            <img src="./img/icon/btn_pen_c.png" alt="" class="" style="width: 21px;">
                                            <span style="font-size: 0.6rem">不規則形工具</span>
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button class="text_btn toolbar_btn" type="button" title="文字工具" id="TextMode"
                                    value="TextMode" name="current-tool-mode">
                                    <img src="./img/icon/btn_text.png" alt="" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button class="clear_btn toolbar_btn" type="button" title="清除" id="EraserMode"
                                    value="EraserMode" name="current-tool-mode" style="padding: 1px 0.35rem;">
                                    <img src="./img/icon/btn_clear.png" alt="" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button class="sacle_btn toolbar_btn " type="button" title="縮放倍率顯示" id="ZoomMode"
                                    value="ZoomMode" name="current-tool-mode">
                                    <img src="./img/icon/btn_sacle.png" alt="" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td> <button class="view_btn fix_function toolbar_btn" type="button" title="小視窗">
                                    <img src="./img/icon/btn_view.png" alt="" class="img-fluid"></button>
                                <div class="view_d">
                                    <div class="view_all_img" id="view_all_img">
                                        <div class="view_part"> </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        <!-- ///小視窗 -->
                        <tr>
                            <td>
                                <!-- 分格線 -->
                                <button type="button" class="toolbar_btn"
                                    style="height: 1px;width:100%;background: #4767A0;margin:1rem 0rem 5px 0rem;padding: 0;border: none"
                                    disabled>
                                </button>
                                <!-- /分格線 -->
                            </td>
                        </tr>
                        <!-- 調色盤 -->
                        <tr>
                            <td>
                                <button class="color_btn fix_function toolbar_btn" type="button" title="調色盤">
                                    <img src="./img/icon/btn_Color.png" alt="" class="img-fluid">
                                </button>
                                <!-- color_d slide_right-->
                                <div class="color_d slide_right">
                                    <div class="" style="margin: 5px 8px 8px 5px; height: .8rem;">
                                        <div>標註定義</div>
                                    </div>
                                    <!--color_d_scoll -->
                                    <div class="layer_d_scoll"
                                        style="width: 100%;height: calc(100% - 1.5rem);overflow: auto;padding: 0 3px 0 5px">
                                        <div class="" style="width: 100%;height:10rem;">
                                            <!-- layer_table -->
                                            <!-- 顏色選擇面版 -->
                                            <div class="color_select_box">
                                                <form action="" class="mx-2 my-2 ">
                                                    <div class=" ">顏色定義：</div>
                                                    <div class="d-flex justify-content-evenly ">
                                                        <input type="radio" name="color_selector" id="color1"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color2"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color3"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color4"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color5"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color6"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color7"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color8"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color9"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color10"
                                                            class="color_selector">
                                                    </div>
                                                    <div class="d-flex justify-content-evenly ">
                                                        <input type="radio" name="color_selector" id="color11"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color12"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color13"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color14"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color15"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color16"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color17"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color18"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color19"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color20"
                                                            class="color_selector">
                                                    </div>
                                                    <div class="d-flex justify-content-evenly ">
                                                        <input type="radio" name="color_selector" id="color21"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color22"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color23"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color24"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color25"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color26"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color27"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color28"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color29"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color30"
                                                            class="color_selector">
                                                    </div>
                                                    <div class="d-flex justify-content-evenly ">
                                                        <input type="radio" name="color_selector" id="color31"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color32"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color33"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color34"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color35"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color36"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color37"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color38"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color39"
                                                            class="color_selector">
                                                        <input type="radio" name="color_selector" id="color40"
                                                            class="color_selector">
                                                    </div>
                                                </form>
                                            </div>
                                            <!-- ///顏色選擇面版 -->
                                            <div style="font-size: 0.65rem;width: 100%;" id="color_table">
                                                <!-- 新增類別 -->
                                                <div class="table_tr no_hover">
                                                    <div>新增類別：</div>
                                                </div>
                                                <div class="table_tr no_hover" id="color_add_btn">
                                                    <div class="t1" style="width: 5.5rem;margin-right: 0.5rem;">
                                                        <input id='input_color' type="text" class=""
                                                            style="height: 0.8rem;width: 100%;">
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " id="select_new_color"
                                                            type="button">
                                                            <div id="select_new_color_div"
                                                                style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3">
                                                        <button class="color_edit_btn color_edit_btn_add"
                                                            type="button">確認</button>
                                                    </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- ///新增類別 -->
                                                <!-- public -->
                                                <!--<div id="color_public">-->
                                                <div class="table_tr color_public" id="color_public1">
                                                    <div class="t1">
                                                        <span id="p1">1.&ensp;Tumnor</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public2 -->
                                                <div class="table_tr color_public" id="color_public2">
                                                    <div class="t1">
                                                        <span id="p2">2.&ensp;Stroma</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public3 -->
                                                <div class="table_tr color_public" id="color_public3">
                                                    <div class="t1">
                                                        <span id="p3">3.&ensp;Immune cells</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public4 -->
                                                <div class="table_tr color_public" id="color_public4">
                                                    <div class="t1">
                                                        <span id="p4">4.&ensp;Benign</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public5 -->
                                                <div class="table_tr color_public" id="color_public5">
                                                    <div class="t1">
                                                        <span id="p5">5.&ensp;Positive</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public6 -->
                                                <div class="table_tr color_public" id="color_public6">
                                                    <div class="t1">
                                                        <span id="p6">6.&ensp;Negative</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public7 -->
                                                <div class="table_tr color_public" id="color_public7">
                                                    <div class="t1">
                                                        <span id="p7">7.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public8 -->
                                                <div class="table_tr color_public" id="color_public8">
                                                    <div class="t1">
                                                        <span id="p8">8.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public9 -->
                                                <div class="table_tr color_public" id="color_public9">
                                                    <div class="t1">
                                                        <span id="p9">9.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public10 -->
                                                <div class="table_tr color_public" id="color_public10">
                                                    <div class="t1">
                                                        <span id="p10">10.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public11 -->
                                                <div class="table_tr color_public" id="color_public11">
                                                    <div class="t1">
                                                        <span id="p11">11.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public12 -->
                                                <div class="table_tr color_public" id="color_public12">
                                                    <div class="t1">
                                                        <span id="p12">12.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public13 -->
                                                <div class="table_tr color_public" id="color_public13">
                                                    <div class="t1">
                                                        <span id="p13">13.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public14 -->
                                                <div class="table_tr color_public" id="color_public14">
                                                    <div class="t1">
                                                        <span id="p14">14.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public15 -->
                                                <div class="table_tr color_public" id="color_public15">
                                                    <div class="t1">
                                                        <span id="p15">15.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public16 -->
                                                <div class="table_tr color_public" id="color_public16">
                                                    <div class="t1">
                                                        <span id="p16">16.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public17 -->
                                                <div class="table_tr color_public" id="color_public17">
                                                    <div class="t1">
                                                        <span id="p17">17.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public18 -->
                                                <div class="table_tr color_public" id="color_public18">
                                                    <div class="t1">
                                                        <span id="p18">18.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public19 -->
                                                <div class="table_tr color_public" id="color_public19">
                                                    <div class="t1">
                                                        <span id="p19">19.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public20 -->
                                                <div class="table_tr color_public" id="color_public20">
                                                    <div class="t1">
                                                        <span id="p20">20.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public21 -->
                                                <div class="table_tr color_public" id="color_public21">
                                                    <div class="t1">
                                                        <span id="p21">21.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public22 -->
                                                <div class="table_tr color_public" id="color_public22">
                                                    <div class="t1">
                                                        <span id="p22">22.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public23 -->
                                                <div class="table_tr color_public" id="color_public23">
                                                    <div class="t1">
                                                        <span id="p23">23.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public24 -->
                                                <div class="table_tr color_public" id="color_public24">
                                                    <div class="t1">
                                                        <span id="p24">24.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public25 -->
                                                <div class="table_tr color_public" id="color_public25">
                                                    <div class="t1">
                                                        <span id="p25">25.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public26 -->
                                                <div class="table_tr color_public" id="color_public26">
                                                    <div class="t1">
                                                        <span id="p26">26.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public27-->
                                                <div class="table_tr color_public" id="color_public27">
                                                    <div class="t1">
                                                        <span id="p27">27.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public28 -->
                                                <div class="table_tr color_public" id="color_public28">
                                                    <div class="t1">
                                                        <span id="p28">28.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public29 -->
                                                <div class="table_tr color_public" id="color_public29">
                                                    <div class="t1">
                                                        <span id="p29">29.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public30 -->
                                                <div class="table_tr color_public" id="color_public30">
                                                    <div class="t1">
                                                        <span id="p30">30.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public31 -->
                                                <div class="table_tr color_public" id="color_public31">
                                                    <div class="t1">
                                                        <span id="p31">31.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public32 -->
                                                <div class="table_tr color_public" id="color_public32">
                                                    <div class="t1">
                                                        <span id="p32">32.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public33 -->
                                                <div class="table_tr color_public" id="color_public33">
                                                    <div class="t1">
                                                        <span id="p33">33.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public34 -->
                                                <div class="table_tr color_public" id="color_public34">
                                                    <div class="t1">
                                                        <span id="p34">34.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public35 -->
                                                <div class="table_tr color_public" id="color_public35">
                                                    <div class="t1">
                                                        <span id="p35">35.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public36 -->
                                                <div class="table_tr color_public" id="color_public36">
                                                    <div class="t1">
                                                        <span id="p36">36.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public37 -->
                                                <div class="table_tr color_public" id="color_public37">
                                                    <div class="t1">
                                                        <span id="p37">37.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public38 -->
                                                <div class="table_tr color_public" id="color_public38">
                                                    <div class="t1">
                                                        <span id="p38">38.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public39 -->
                                                <div class="table_tr color_public" id="color_public39">
                                                    <div class="t1">
                                                        <span id="p39">39.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- public40 -->
                                                <div class="table_tr color_public" id="color_public40">
                                                    <div class="t1">
                                                        <span id="p40">40.&ensp;Other</span>
                                                    </div>
                                                    <div class="t2">
                                                        <button class="tran_btn color_color " type="button">
                                                            <div style="background-color: greenyellow"></div>
                                                        </button>
                                                    </div>
                                                    <div class=" t3"> </div>
                                                    <div class="t4"> </div>
                                                </div>
                                                <!-- ///public -->
                                                <div class="table_tr no_hover">
                                                    <!-- 分格線 -->
                                                    <div
                                                        style="height: 1px;width:100%;background: #4767A0;margin:5px 0rem 5px 0rem;padding: 0;border: none">
                                                    </div>
                                                </div>
                                                <div class="table_tr no_hover">
                                                    <div>Private:</div>
                                                </div>
                                                <!--/第一塊 -->
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private1">
                                                        <div class="t1 color_input">
                                                            <span>1.&ensp;</span>
                                                            <input name="pp1" type="text" value="Tumnor00" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button type="button"
                                                                class="tran_btn color_color edit_color" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button type="button" class="color_edit_btn">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button type="button" class="tran_btn p-0 pr-1">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第一塊 -->
                                                    <!--第二塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private2">
                                                        <div class="t1 color_input">
                                                            <span>2.&ensp;</span>
                                                            <input name="pp2" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第二塊 -->
                                                    <!-- ///第三塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private3">
                                                        <div class="t1 color_input"><span>3.&ensp;</span>
                                                            <input name="pp3" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </form>
                                                <!-- ///第三塊 -->
                                                <!--第4塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private4">
                                                        <div class="t1 color_input">
                                                            <span>4.&ensp;</span> <input name="pp4" type="text"
                                                                value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4"> <button class="tran_btn p-0 pr-1 "
                                                                type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第4塊 -->
                                                    <!--第5塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private5">
                                                        <div class="t1 color_input">
                                                            <span>5.&ensp;</span>
                                                            <input name="pp5" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第5塊 -->
                                                    <!--第6塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private6">
                                                        <div class="t1 color_input">
                                                            <span>6.&ensp;</span> <input name="pp6" type="text"
                                                                value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第6塊 -->
                                                    <!--第7塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private7">
                                                        <div class="t1 color_input">
                                                            <span>7.&ensp;</span> <input name="pp7" type="text"
                                                                value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4"> <button class="tran_btn p-0 pr-1 "
                                                                type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第7塊 -->
                                                    <!--第8塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private8">
                                                        <div class="t1 color_input">
                                                            <span>8.&ensp;</span>
                                                            <input name="pp8" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第8塊 -->
                                                    <!--第9塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private9">
                                                        <div class="t1 color_input">
                                                            <span>9.&ensp;</span>
                                                            <input name="pp9" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第9塊 -->
                                                    <!--第10塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private10">
                                                        <div class="t1 color_input">
                                                            <span>10.&ensp;</span>
                                                            <input name="pp10" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第10塊 -->
                                                    <!--第11塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private11">
                                                        <div class="t1 color_input">
                                                            <span>11.&ensp;</span>
                                                            <input name="pp11" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第11塊 -->
                                                    <!--第12塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private12">
                                                        <div class="t1 color_input">
                                                            <span>12.&ensp;</span>
                                                            <input name="pp12" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第12塊 -->
                                                    <!--第13塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private13">
                                                        <div class="t1 color_input">
                                                            <span>13.&ensp;</span>
                                                            <input name="pp13" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第13塊 -->
                                                    <!--第14塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private14">
                                                        <div class="t1 color_input">
                                                            <span>14.&ensp;</span>
                                                            <input name="pp14" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第14塊 -->
                                                    <!--第15塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private15">
                                                        <div class="t1 color_input">
                                                            <span>15.&ensp;</span>
                                                            <input name="pp15" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第15塊 -->
                                                    <!--第16塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private16">
                                                        <div class="t1 color_input">
                                                            <span>16.&ensp;</span>
                                                            <input name="pp16" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第16塊 -->
                                                    <!--第17塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private17">
                                                        <div class="t1 color_input">
                                                            <span>17.&ensp;</span>
                                                            <input name="pp17" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第17塊 -->
                                                    <!--第18塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private18">
                                                        <div class="t1 color_input">
                                                            <span>18.&ensp;</span>
                                                            <input name="pp18" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第18塊 -->
                                                    <!--第19塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private19">
                                                        <div class="t1 color_input">
                                                            <span>19.&ensp;</span>
                                                            <input name="pp19" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第19塊 -->
                                                    <!--第20塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private20">
                                                        <div class="t1 color_input">
                                                            <span>20.&ensp;</span>
                                                            <input name="pp20" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第20塊 -->
                                                    <!--第21塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private21">
                                                        <div class="t1 color_input">
                                                            <span>21.&ensp;</span>
                                                            <input name="pp21" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第21塊 -->
                                                    <!--第22塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private22">
                                                        <div class="t1 color_input">
                                                            <span>22.&ensp;</span>
                                                            <input name="pp22" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第22塊 -->
                                                    <!--第23塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private23">
                                                        <div class="t1 color_input">
                                                            <span>23.&ensp;</span>
                                                            <input name="pp23" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第23塊 -->
                                                    <!--第24塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private24">
                                                        <div class="t1 color_input">
                                                            <span>24.&ensp;</span>
                                                            <input name="pp24" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第24塊 -->
                                                    <!--第25塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private25">
                                                        <div class="t1 color_input">
                                                            <span>25.&ensp;</span>
                                                            <input name="pp25" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第25塊 -->
                                                    <!--第26塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private26">
                                                        <div class="t1 color_input">
                                                            <span>26.&ensp;</span>
                                                            <input name="pp26" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第26塊 -->
                                                    <!--第27塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private27">
                                                        <div class="t1 color_input">
                                                            <span>27.&ensp;</span>
                                                            <input name="pp27" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第27塊 -->
                                                    <!--第28塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private28">
                                                        <div class="t1 color_input">
                                                            <span>28.&ensp;</span>
                                                            <input name="pp28" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第28塊 -->
                                                    <!--第29塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private29">
                                                        <div class="t1 color_input">
                                                            <span>29.&ensp;</span>
                                                            <input name="pp29" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第29塊 -->
                                                    <!--第30塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private30">
                                                        <div class="t1 color_input">
                                                            <span>30.&ensp;</span>
                                                            <input name="pp30" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第30塊 -->
                                                    <!--第31塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private31">
                                                        <div class="t1 color_input">
                                                            <span>31.&ensp;</span>
                                                            <input name="pp31" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第31塊 -->
                                                    <!--第32塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private32">
                                                        <div class="t1 color_input">
                                                            <span>32.&ensp;</span>
                                                            <input name="pp32" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3"> <button class="color_edit_btn"
                                                                type="button">修改</button> </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第32塊 -->
                                                    <!--第33塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private33">
                                                        <div class="t1 color_input">
                                                            <span>33.&ensp;</span>
                                                            <input name="pp33" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第33塊 -->
                                                    <!--第34塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private34">
                                                        <div class="t1 color_input">
                                                            <span>34.&ensp;</span>
                                                            <input name="pp34" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第34塊 -->
                                                    <!--第35塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private35">
                                                        <div class="t1 color_input">
                                                            <span>35.&ensp;</span>
                                                            <input name="pp35" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第35塊 -->
                                                    <!--第36塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private36">
                                                        <div class="t1 color_input">
                                                            <span>36.&ensp;</span>
                                                            <input name="pp36" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第36塊 -->
                                                    <!--第37塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private37">
                                                        <div class="t1 color_input">
                                                            <span>37.&ensp;</span>
                                                            <input name="pp37" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第37塊 -->
                                                    <!--第38塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private38">
                                                        <div class="t1 color_input">
                                                            <span>38.&ensp;</span>
                                                            <input name="pp38" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第38塊 -->
                                                    <!--第39塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private39">
                                                        <div class="t1 color_input">
                                                            <span>39.&ensp;</span>
                                                            <input name="pp39" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第39塊 -->
                                                    <!--第40塊 -->
                                                </form>
                                                <form action="">
                                                    <div class="table_tr color_private" id="color_private40">
                                                        <div class="t1 color_input">
                                                            <span>40.&ensp;</span>
                                                            <input name="pp40" type="text" value="Tumnor" readonly>
                                                        </div>
                                                        <div class="t2">
                                                            <button class="tran_btn color_color  edit_color"
                                                                type="button" disabled>
                                                                <div style="background-color: greenyellow"></div>
                                                            </button>
                                                        </div>
                                                        <div class=" t3">
                                                            <button class="color_edit_btn" type="button">修改</button>
                                                        </div>
                                                        <div class="t4">
                                                            <button class="tran_btn p-0 pr-1 " type="button">
                                                                <i class="far fa-trash-alt"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <!-- ///第40塊 -->
                                            </div>
                                            <!-- ///layer_table -->
                                        </div>
                                    </div>
                                    <!-- ///layer_d_scoll -->
                                </div>
                                <!-- ///layer_d  slide_right-->
                            </td>
                        </tr>
                        <!-- ///調色盤 -->
                        <!-- 圖層 -->
                        <tr>
                            <td>
                                <button class="layer_btn  fix_function toolbar_btn" type="button" title="圖層">
                                    <img src="./img/icon/btn_Layer.png" alt="" class="img-fluid">
                                </button>
                                <!-- layer_d slide_right-->
                                <div class="layer_d slide_right">
                                    <div class=" d-flex justify-content-between"
                                        style="margin: 5px 8px 8px 5px; height: .8rem;">
                                        <div>標註管理</div>
                                        <span class="text-right">
                                            <label class="check_tran">
                                                <input type="checkbox" class="checkbox" name="show_all_layer"
                                                    id="show_all_layer" checked />
                                                <span class="btn-box">
                                                    <span class="btn"></span>
                                                </span>
                                                <label for="show_all_layer" class="small">顯示全部標註</label>
                                            </label>
                                        </span>
                                    </div>
                                    <div class=" layer_d_scoll"
                                        style="width: 100%;height: calc(100% - 1.5rem);overflow: auto">
                                        <div class="" style="width: 100%;height:10rem;">
                                            <!-- layer_table -->
                                            <div style="font-size: 0.65rem;width: 100%;" id="layer_table">
                                                <div class="table_tr no_hover">
                                                    <div>Public:</div>
                                                </div>
                                            </div>
                                            <!-- ///layer_table -->
                                        </div>
                                    </div>
                                </div>
                                <!-- ///layer_d  slide_right-->
                            </td>
                        </tr>
                        <!-- ///圖層 -->
                    </tbody>
                </div>
                <div id="bottom">
                    <tbody>
                        <tr>
                            <td>
                                <button class="back_btn toolbar_btn bottom_btn_hover" type="button" title="上傳至雲象"
                                    onclick="postAetherAI()">
                                    <img src="./img/icon/updown.png" alt="" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <button class="back_btn toolbar_btn bottom_btn_hover" type="button" title="返回上頁"
                                    onclick="toList()">
                                    <img src="./img/icon/btn_back.png" alt="" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                        <tr>
                        <tr>
                            <td>
                                <button class="back_btn toolbar_btn bottom_btn_hover" id="saveCase" type="button"
                                    title="儲存圖形">
                                    <img src="./img/icon/btn_save.png" class="img-fluid">
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </div>

            </div>
        </div>
    </div>
    <script>
        let painterApp;
        const token = JSON.parse(localStorage.getItem("accessToken"));
        const filePath = localStorage.getItem("filePath");
        const API_URL = localStorage.getItem("API_URL");
        const waitTime = 100

        let strokeColor = '#697723'
        let strokelabel = 'Tumor'
        let strokelabelADD = 'Tumor'
        let willdeleteColor
        let labelclass = {}
        let workFlag = true;
        let color_arr = ["#ff0000", "#ff7f00", "#697723", "#002266", "#7400a1", "#483d8b", "#990036", "#16982b", "#4d1f00", "#000000", "#ff4500", "#e29d03", "#006400", "#0033ff", "#9400d3", "#6640ff", "#cc0080", "#22c32e", "#8b4513", "#696969", "#f08080", "#ffc82e", "#00ff00", "#1e90ff", "#ff00ff", "#9370db", "#ff83c7", "#98fb98", "#cc7722", "#c0c0c0", "#ffaebe", "#fffa00", "#e4ff71", "#00ffff", "#f992ff", "#c5afdd", "#ffd9e6", "#a6ffcc", "#ffe4c4", "#ffffff"]

        /*PIFV*/
        let flag = false;
        let width;
        let height;
        let countLevels;
        let _layer;
        let defaultTileWidth = 512;
        let series = {
            Resolutions: [],
            TileHeight: 512,
            TileWidth: 512,
            TotalHeight: 0,
            TotalWidth: 0,
            LevelData: {},
        };
        let map;
        let miniMap;
        let context;
        let imageonload = false;
        let imageInfoLabel;
        let _currentIsyntaxImageName;
        let isAnnotationElem = false;
        let modeChange;
        let subscriptions = [];
        let _currentIsyntaxImageLocation = "";
        let _featureColor;
        let activeInteraction;
        let vectorSource;
        let vectorLayer;
        let _showAnnotations = true;
        let _draw;
        let _featureShape;
        let _sketch;
        let _listener;
        let currentMapMode = "";
        let initcolor;
        let _featureFillColor = 'rgba(0,0,0,0)'; // 
        let _snap;
        let _delete;
        let _select;
        let _modify;
        let _deleteSelect;
        let measureIndex;
        let _measureTooltipElement;
        let annotations;
        let layerJSON = []
        let removeIDlist = []
        let privateIndex = 0
        let textList = []
        let textidList = [];
        let featureJSON = '';
        let featureJSON_transform = '';
        let textJSON = '';
        let msgList;
        let textCount;
        let oldColor = "";
        let selectID = "";
        let classObj;
        let sendStatus = 'no';
        let outputArea;
        let feature_geom;
        let esctouch = false;
        const featureProjtn = 'EPSG:3857';
        const featureProjtn_transform = '';
        let _geojsonObject =
        {
            type: '',
            features: ''
        }
        /*create json*/
        let _format = new ol.format.GeoJSON({
            featureProjection: featureProjtn,
        });

        let _format_transform = new ol.format.GeoJSON({
            featureProjection: featureProjtn_transform,
        });
        /*GET 驗證玻片圖片*/
        function getLevelList() {
            return axios.
                get(APP_URL.URL + PORT.PORT + APP_URL.VALIDATE_FILE + FILE_LOCATION.PATH, {
                    responseType: 'json',
                });
        }
        /*GET 玻片縮放比例*/
        function getScale() {
            return axios.
                get(APP_URL.URL + PORT.PORT + APP_URL.SCALE + FILE_LOCATION.PATH, {
                    responseType: 'json',
                });
        }
        const APP_URL = {
            URL: API_URL,
            MACRO_IMAGE: '/getMacroImage/', // 縮圖-縮圖
            LABEL_IMAGE: '/getLabelImage/', // 縮圖-條碼
            VALIDATE_FILE: '/validateFile/', // 驗證圖片
            FILE_METADATA: '/getFileMetaData/', // 幫助提示
            SCALE: '/getScale/', // 縮放
            SHUTDOWN: '/', // 關閉server
            GET_PATCH: '/getPatch/', // 提取圖片
            // 開圖順序: VALIDATE_FILE -> SCALE -> SCALE -> GET_PATCH
            // 開縮圖: MACRO_IMAGE -> LABEL_IMAGE
            // 開幫助提示: FILE_METADATA
            // 玻片放大縮小: GET_PATCH*?
        };
        const PORT = {
            PORT: '4003',//開發用4003 正式版4005
        };
        const DIMENSION_UNITS = {
            CENTI_METER: 'CentiMeter',
            MILLI_METER: 'MilliMeter',
            MICRO_METER: 'MicroMeter',
            NANO_METER: 'NanoMeter',
            PICO_METER: 'PicoMeter',
        };
        const FILE_LOCATION = {
            PATH: '',
        };
        const AnnotationShapes = {
            FreeformPolygon: 'FreeformPolygon',
            Polygon: 'Polygon',
            Rectangle: 'Rectangle',
            Circle: 'Circle',
            Line: 'LineString',
            None: 'None',
        };
        const ZOOM_FACTOR = {
            0: '40X',
            1: '20X',
            2: '10X',
            3: '5X',
            4: '2X',
            5: '1X',
            6: '0.5X',
            7: '0.25X',
            8: '0.1X',
            9: '0.05X',
            10: '0.02X',
            11: '0.01X',
        };
        const MODE = {
            DRAW: 'Draw',
            PAN: 'Pan',
            EDIT: 'Edit',
            DELETE: 'Delete',
            TEXT: 'Text',
        };
        const AnnotationData =
            [ // 給圖形功能
                {
                    value: 'FreeformPolygon',
                    active: false,
                },
                {
                    value: 'Polygon',
                    active: false,
                },
                {
                    value: 'Rectangle',
                    active: false,
                },
                {
                    value: 'Circle',
                    active: false,
                },
                {
                    value: 'LineString',
                    active: false,
                },
                {
                    value: 'None',
                    active: false,
                },
            ];

        /**
         * Returns the scale value based on measurement values
         * @param  {IScale} scaleData
         */
        function getScaleData(scaleData) {
            let scaleValue;
            const scale = scaleData.x.scale;
            switch (scaleData.x.dimension_units) {
                case DIMENSION_UNITS.CENTI_METER:
                    scaleValue = scale / 10000;
                    break;
                case DIMENSION_UNITS.MILLI_METER:
                    scaleValue = scale / 1000;
                    break;
                case DIMENSION_UNITS.MICRO_METER:
                    scaleValue = scale;
                    break;
                case DIMENSION_UNITS.NANO_METER:
                    scaleValue = scale * 1000;
                    break;
                case DIMENSION_UNITS.PICO_METER:
                    scaleValue = scale * 1000000;
                    break;
                default:
                    scaleValue = scale;
            }
            return scaleValue;
        }
        /**
         * Sets the current operation mode for map
         * @param  {string} mode
         */
        function setMode(mode) {
            modeChange = mode;
            currentMapMode = mode;
        }
        /**
         * Returns the selected color for a feature
         */
        function getFillObject() {
            return new ol.style.Fill({
                color: _featureFillColor,
            });
        }
        /**
         * Assigns the given color as stroke color for a feature with width = 3
         * @param  {string} colorCode
         */
        function getStrokeObject(colorCode) {
            return new ol.style.Stroke({
                color: colorCode,
                width: 3,
            });
        }
        /**
         * Sets the selected color for feature 設定畫筆顏色
         * @param  {string} colorCode
         */
        function setColorForFeature(colorCode) {
            _featureColor = colorCode;
        }
        /**
         * Returns current feature color
         */
        function getColorForFeature() {
            return _featureColor;
        }
        /**
         * Returns current shape color
         */
        function getShapeForFeature() {
            return _featureShape;
        }
        /**
         * Updates the themeColor for feature
         * @param colorCode The colorcode for feature
         */
        function onColorChange(colorCode) {
            setThemeIconColor(colorCode);
        }
        /**
         * Sets the deafult color and updates the color for feature
         * @param element The HTMLElement that shows the selected color
         * @param colorCode The default color code for feature
         */
        function setThemeIconColor(colorCode) {
            setColorForFeature(colorCode);
        }
        /**
         * Sets the styles for current feature based on selected mode
         */
        function setFeatureStyles() {
            if (vectorLayer) {
                const feature = vectorLayer.getSource().getFeatures();
                feature.forEach(() => {
                    vectorLayer.setStyle((type) => {
                        let tooltipElement;
                        // const shapeID = type.getId();
                        // if (shapeID) {
                        //     tooltipElement = document.getElementById('measure_' + shapeID.toString());
                        // }
                        // if (currentMapMode === MODE.EDIT && (type.getProperties().geometryShape === AnnotationShapes.Circle || type.getProperties().geometryShape === AnnotationShapes.FreeformPolygon)) {
                        //     if (tooltipElement) {
                        //         tooltipElement.style.visibility = 'hidden';
                        //     }
                        //     return new ol.style.Style(undefined);
                        // }
                        // else {
                        //     if (tooltipElement) {
                        //         tooltipElement.style.visibility = 'visible';
                        //     }
                        return new ol.style.Style({
                            fill: getFillObject(),
                            stroke: getStrokeObject(type.getProperties().hexCode),
                        });
                        // }
                    }
                    );
                });
            }
        }

        // coordinate system
        initializeFeatureGeoJSON();
        /**
         * Initilaizes the FeatureGeoJSONObject
         */
        function initializeFeatureGeoJSON() {
            return (_geojsonObject = {
                type: 'FeatureCollection',
                features: [],
            });
        }
        /**
         * Writes the annotation changes to session storage for current Isyntax image 載入/更新標註
         * @param  {string} feature
         */
        async function writeFeaturesToSessionStorage(feature) {
            const selectedFile = _currentIsyntaxImageLocation.concat('\\', _currentIsyntaxImageName);
            const updatedFile = sessionStorage.getItem(selectedFile + '-updated');
            const originalFile = sessionStorage.getItem(selectedFile + '-original');
            if (!updatedFile && !originalFile) {
                sessionStorage.setItem(selectedFile + '-original', feature);
            } else if (originalFile && !updatedFile) {
                const selectedOriginalFile = sessionStorage[selectedFile + '-original'];
                sessionStorage.setItem(selectedFile + '-updated', selectedOriginalFile);
                sessionStorage.setItem(selectedFile + '-updated', feature);
            } else if (updatedFile) {
                sessionStorage.setItem(selectedFile + '-updated', feature);
            }
            //----------//----------//----------//----------//----------//
            featureJSON_transform = _format_transform.writeFeatures(vectorSource.getFeatures());
            await refresh_Feature_list(); //David_20210527
            refresh_Feature_list_Other()
            $('#show_all_layer').prop('checked', false); //David_20210526
            $('#show_all_layer').prop('checked', true); //David_20210526
        }
        /**
         * Looks for any change (addition, change, deletion of a feature) on vector source and
         * updates the feature styles and session storage accordingly
         * 監聽vectorSource層的改變
         */
        function watchVectorSourceChanges() {
            vectorSource.on('addfeature', (feature) => { // 加入新圖形
                //console.log("00000000000000000");
                //console.log(feature);
                feature.feature.setProperties({
                    hexCode: getColorForFeature(),
                    geometryShape: getShapeForFeature(),
                });
                setFeatureStyles();
                // 刪除一個點的標註(面積等於0)
                if (outputArea <= 0) {
                    // console.log(feature.feature);
                    vectorSource.removeFeature(feature.feature);
                    sendStatus = 'no';
                }
                else {
                    sendStatus = 'yes';
                }
            });

            // this event takes care of all common tasks to be performed upon addition, change, deletion of a feature
            vectorSource.on('change', () => {
                //console.log("123456");
                const feature = vectorSource.getFeatures();
                //console.log(feature);
                // console.log("000011111111111000 " + sendStatus + feature.length);
                if (feature.length >= 0) {
                    //console.log(feature);
                    // console.log('**** ' + _format.writeFeatures(feature));
                    const json = _format.writeFeatures(feature);
                    featureJSON = json;
                    if (sendStatus == 'yes' || sendStatus == 'edit') {
                        sendCase_imm();
                        if (sendStatus == 'yes') {
                            sendStatus = 'no';
                        }
                    }

                    writeFeaturesToSessionStorage(json);
                    esctouch = false;
                }
            });
        }
        /**
         * Returns the current Isyntax file
         */
        function getCurrentIsyntaxImageName() {
            return _currentIsyntaxImageName;
        }
        /**
         * Sets the current Isyntax file
         * @param  {string} imageName
         */
        function setCurrentIsyntaxImageName(imageName) {
            _currentIsyntaxImageName = imageName;
        }
        /**
         * Sets the current Isyntax file location/path
         * @param  {string} currentFileLocation
         */
        function setCurrentFileLocation(currentFileLocation) {
            const separatorIndex = currentFileLocation.lastIndexOf('\\');
            currentFileLocation = currentFileLocation.slice(0, separatorIndex);
            _currentIsyntaxImageLocation = currentFileLocation;
        }
        /**
         * 地圖圖磚
         * Creates the tile layer for isyntax file
         * @param  {Extent} extn
         * @param  {Projection} proj
         * @param  {string} fileLocation
         */
        function createLayer(extn, proj, fileLocation, scale) {
            return new ol.layer.Tile({
                extent: extn,
                source: new ol.source.TileImage({
                    projection: proj, // 坐標系
                    tileUrlFunction: function (tileCoord) { // 針對tile coordinate 做處理 // tileCoord 地圖圖磚 ， TileCoord 為型別
                        // console.log("xx");
                        const zoomLevel = countLevels - 1 - tileCoord[0];
                        const tileRow = Math.abs(tileCoord[2]) - 1;
                        const tileColumn = tileCoord[1];
                        const factor = Math.pow(2, zoomLevel);
                        tileWidthAtLevel = defaultTileWidth * factor;
                        // console.log(tileCoord[0]+" "+tileCoord[2]+" "+tileCoord[1]);
                        // console.log("$$ " + tileCoord + " " + zoomLevel + " " + tileRow + " " + tileColumn + " " + factor + " // " + countLevels + " " + defaultTileWidth + " " + tileWidthAtLevel);
                        if (map) {
                            // console.log("*.*");
                            map.on('moveend', () => {
                                // console.log("*..*");
                                const zoomInfo = Math.abs(map.getView().getZoom() - (countLevels - 1));
                                const scaleFactor = Math.pow(2, zoomInfo);
                                const scaleValue = Number(scale) * scaleFactor;
                                // console.log('xx');
                                // console.log(zoomInfo + " " + scaleFactor + " " + scaleValue + " " + scale + " " + this.map.getView().getZoom());
                                if (imageInfoLabel) {
                                    // console.log("*...*");
                                    imageInfoLabel.innerHTML =
                                        '<span class="pt-icon icon-dls-measurement"></span><label>' +
                                        scaleValue.toString() +
                                        'μm</label><span class="pt-icon icon-dls-search image-info-zoom"></span><label>' +
                                        ZOOM_FACTOR[zoomInfo] +
                                        '</label>';
                                }
                            });
                            map.updateSize();
                        }

                        const x1 = series.LevelData[zoomLevel][0][0] + tileColumn * tileWidthAtLevel;
                        const x2 = series.LevelData[zoomLevel][0][0] + ((tileColumn + 1) * tileWidthAtLevel - factor);
                        const y1 = series.LevelData[zoomLevel][1][0] + tileRow * tileWidthAtLevel;
                        const y2 = series.LevelData[zoomLevel][1][0] + ((tileRow + 1) * tileWidthAtLevel - factor);
                        // console.log(series.LevelData[zoomLevel][0][0]+" "+series.LevelData[zoomLevel][1][0]+" "+tileColumn+" "+tileWidthAtLevel+" "+factor);
                        // console.log(`${x1}, ${x2}, ${y1}, ${y2} + ${width} + ${height}`);
                        return x1 < width &&
                            x2 <= width + tileWidthAtLevel &&
                            y1 < height &&
                            y2 <= height + tileWidthAtLevel
                            ? APP_URL.URL + PORT.PORT + APP_URL.GET_PATCH + FILE_LOCATION.PATH +
                            '/' +
                            x1.toString() +
                            '/' +
                            y1.toString() +
                            '/' +
                            x2.toString() +
                            '/' +
                            y2.toString() +
                            '/' +
                            zoomLevel.toString()
                            : '';
                    },
                    tileGrid: new ol.tilegrid.TileGrid({ // 格網信息
                        extent: extn,
                        resolutions: series.Resolutions.reverse(),
                        tileSize: [defaultTileWidth, defaultTileWidth],
                    }),
                }),
            });
        }
        /**
         * Wires the tileLayers to canvas
         * @param  {TileLayer} layer
         */
        function wireLayerEvents(layer) {
            // console.log("write");
            layer.on('prerender', (event) => {
                context = event.context.canvas.getContext('2d');
                if (context) {
                    context.imageSmoothingEnabled = false;
                }
            });
        }
        /**
         * Creates a map for the isyntax file
         * @param  {Projection} proj
         * @param  {Collection<Interaction>} interactions
         */
        function createMap(proj, interactions) {
            createMiniMap(proj, interactions)
            const viewOptions = {
                constrainResolution: true,
                projection: proj,
                center: [width / 2, -height / 2],
                zoom: 0, // 視圖層級
                // minZoom: 0, // 最小視圖層級
                // maxZoom: 10, // 最大視圖層級
                resolutions: series.Resolutions,
                extent: [0, -height, width, height / 4], // 限制移動區域
            };
            const mapOptions = {
                target: 'painter_app', // 要顯示於html的位置
                layers: [_layer], // 圖層
                keyboardEventTarget: document, // 監聽鍵盤事件的元素，如果將此選項設置為 document鍵盤，則交互將始終觸發
                pixelRatio: 1, // 設備上物理像素與設備無關像素（dip）之間的比率
                view: new ol.View(viewOptions), // 地圖的視圖
                interactions: ol.interaction.defaults({
                    doubleClickZoom: false,   //屏蔽雙擊放大事件
                    // dragAndDrap: false,
                    // dragRotate: false,
                    // dragPan: false,
                    // pinchRotate: false,
                    // pinchZoom: false,
                    // keyboardPan: false,
                    // keyboardZoom: false,
                    // dragZoom: false,
                    // mouseWheelZoom: false,
                    // pointerInteraction: false,

                }), // 最初添加到地圖的互動
                controls: ol.control.defaults({
                    //zoom: false, // 不顯示放大放小按鈕
                    rotate: false, // 不顯示指北針控件
                    attribution: false // 不顯示右下角的地圖信息控件
                })
                    // 擴增功能
                    .extend([
                        // scaleLine, // 比例尺
                        // mousePosition, // 顯示當前鼠標位置
                        addImageInfoLabelControl(), // 畫布左下縮放倍率訊息顯示
                        miniMap
                    ])
            };
            // console.log("map");
            map = new ol.Map(mapOptions); // 左上加減button
            // console.log(_layer)
            addLayerForFeatures(map); // 加上標註圖形
            return map;
        }
        //產出小地圖
        function createMiniMap(proj, interactions) {
            const miniviewOptions = {
                constrainResolution: true,
                projection: proj,
                center: [width / 2, -height / 2],
                zoom: 0, // 視圖層級
                resolutions: series.Resolutions,
                extent: [0, -height, width, height / 4], // 限制移動區域
                constrainOnlyCenter: true
            };
            const miniMapOptions = {
                layers: [_layer], // 圖層
                pixelRatio: 1, // 設備上物理像素與設備無關像素（dip）之間的比率
                view: new ol.View(miniviewOptions), // 地圖的視圖
                collapsed: false
            };
            miniMap = new ol.control.OverviewMap(miniMapOptions)
        }
        /**
         * Resets all the map interactions
         * @param  {Map} map
         */
        function resetInteractions() {
            // document.removeEventListener('keydown', null);
            // addEscListener();
            esctouch = true;
            if (document.getElementById("popup-content")) {
                document.getElementById("popup-content").removeEventListener("keydown", null);
                document.getElementById("popup").parentNode.remove();
            }
            map.removeEventListener("click", null);
            map.removeInteraction(_snap); // ol.interaction.Snap
            map.removeInteraction(_delete); // ol.interaction.Select
            map.removeInteraction(_draw); // ol.interaction.Draw
            map.removeInteraction(_select); // ol.interaction.Select
            map.removeInteraction(_modify); // ol.interaction.Modify
            map.removeInteraction(_deleteSelect);
            sendStatus = 'no';
        }
        /**
         * 轉換畫圖模式
         * Toggles the draw mode when active annotation shape is changed
         * @param  {SimpleChanges} activeShape The activeShape of annotation type
         */
        function ngOnChanges(activeShape) {
            if (map) {
                map = toggleDrawMode(map, activeShape.activeShapeDetails.currentValue);
            }
        }
        /**
         * 建立文字text的json
         * @param  {coordinate} 文字text左上座標
         */
        function settextjson(coordinate, id, textvalue) {
            //alert(textvalue);
            if (measureIndex == 0) {
                measureIndex = localStorage.getItem("id") != null ? localStorage.getItem("id") : 0;
            }
            let textid = id < 0 ? measureIndex : id;

            let json = {
                type: "Text",
                value: textvalue,
                coordinates: [[coordinate]],
                hexCode: "#000000",
                geometryShape: "Text",
                id: textid,
            };
            //if (id < 0) {

            //}
            textList.push(json)
            textJSON = textList
            // console.log("settextjson : ", textJSON, textList);
            sendCase_imm()
            refresh_note_list_text(textJSON);
            measureIndex++;
        }
        /**
         * 建立文字text輸入框、建立文字內容在map上
         * @param  {text} 初始的文字內容
         */
        function createTextObj(text) {
            resetInteractions(); // 重整互動模式
            setMode(MODE.TEXT); // 改變模式
            setAnnotationMode(MODE.TEXT); // 設定標註畫筆模式

            // 建立文字輸入框
            content = document.createElement("INPUT");
            content.setAttribute("type", "text");
            content.setAttribute("value", text);
            content.setAttribute("placeholder", "輸入");
            content.setAttribute("id", 'popup-content');
            container = document.createElement('div');
            container.setAttribute("id", "popup");
            container.appendChild(content); // div裝文字輸入框


            let coordinate;
            let overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */({
                element: container,
                autoPan: true,
                autoPanAnimation: {
                    duration: 250   // 當Popup超出地圖邊界時，為了Popup全部可見，地圖移動的速度. 單位為毫秒（ms）
                }
            }));

            // 點擊map任一點顯示文字輸入框
            map.addEventListener('click', function (evt) {
                container.style = 'display:block';
                coordinate = evt.coordinate; // 座標
                //console.log(coordinate);
                let hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
                    coordinate, 'EPSG:3857', 'EPSG:4326'));
                overlay.setPosition(coordinate);
                map.addOverlay(overlay);
            });

            // 輸入框按enter鍵
            content.addEventListener('keydown', function (e) {
                //content.removeEventListener('keydown');
                // hide on enter
                if (e.keyCode === 13) {
                    try {
                        //alert(content.value);
                        createTexttip([0, 0]); // 創建元素
                        measureText(content.value, coordinate, measureIndex);
                        settextjson(coordinate, -1, content.value);
                        //container.style = 'display: none';
                        //content.value = '';
                        // 刪除文字輸入框
                        removeDuplicate(); // 去除重複文字元素
                        //content.remove();
                        //container.remove();
                        container.parentNode.remove();
                        // 創建文字內容
                        createTextObj("");

                    }
                    catch { }

                }
            });
        }
        /**
         * Emits current annotation details
         * @param  {IAnnotationShape} shapeDetails
         */
        function annotationShapeChanged(shapeDetails) {
            // console.log(shapeDetails);
            this.currentAnnotationShape.emit(JSON.parse(JSON.stringify(shapeDetails)));
        }
        /**
         * Activates the selected annotation, updates the selected icon and emits the event
         * with selected annotation
         * @param shape The annotation shape that needs to be drawn
         * @param iconClass The iconClass for selected annotation
         */
        function drawAnnotation(shape) {
            //console.log(shape);
            //console.log(iconClass);
            if (getCurrentIsyntaxImageName()) {
                AnnotationData.forEach((element) => {
                    if (element.value === shape) {
                        element.active = true;
                        //console.log(this.annotationButtonIcon);
                        //console.log(element);
                        //this.annotationButtonIcon.className = iconClass || this.defaultAnnotationIconClass;
                        //activeShapeChanged.emit(element);
                    }
                    else {
                        //console.log(element);
                        element.active = false;
                    }
                });
            }
        }
        /**
         * Calculates the area for the annotation
         * @param  {Geometry} polygon
         * @param  {string} scale
         */
        function formatArea(polygon, scale) {
            let output;
            const area = ol.sphere.getArea(polygon);
            const scaledArea = Number(area) * Math.pow(Number(scale), 2);
            if (scaledArea > 1000) {
                output = parseFloat((scaledArea / 1000000).toFixed(3));
            } else {
                output = parseFloat(scaledArea.toFixed(3));
            }
            return output;
        }
        /**
         * Measures the shape and updates the measurement info while drawing an annotation
         * @param  {Draw} draw
         * @param  {Map} map
         */
        function measureShape(draw, map) {
            let geom;
            // 開始畫圖
            draw.on('drawstart', (evt) => {
                _sketch = evt.feature;
                //console.log("000");
                //console.log(evt.feature.getGeometry());
                _listener = _sketch.getGeometry().on('change', (event) => {
                    //console.log("111");
                    esctouch = true;
                    geom = event.target;
                    //console.log();
                    feature_geom = geom;
                    //console.log(_tooltipCoord);
                    //let output = '';
                    if (geom instanceof ol.geom.Polygon) {
                        outputArea = formatArea(geom, scale);
                        _tooltipCoord = geom.getFirstCoordinate();

                    }
                    else if (geom instanceof ol.geom.LineString) {
                        //output = this.formatLength(geom, this.scale);
                        _tooltipCoord = geom.getLastCoordinate();
                    }
                    // if (_measureTooltipElement) {
                    //     _measureTooltipElement.innerHTML = '12mmm';
                    // }
                    // _measureTooltip.setPosition(_tooltipCoord);
                });
            });
            // 畫圖完畢
            draw.on('drawend', (evt) => {
                if (measureIndex == 0) {
                    measureIndex = localStorage.getItem("id") != null ? localStorage.getItem("id") : 0;
                }
                let temp = evt.feature.getGeometry().getCoordinates()[0];
                evt.feature.setId(measureIndex); // 設定圖形json id
                measureIndex++;

                // if (_measureTooltipElement) {

                //     evt.feature.setId(measureIndex);
                //     _measureTooltipElement.className = 'ol-tooltip ol-tooltip-static ';
                //     _measureTooltipElement.id = 'measure_' + measureIndex.toString();
                //     _measureTooltip.setOffset([0, -7]);
                //     // unset this._sketch
                //     _sketch = null;
                //     // unset tooltip so that a new one can be created
                //     _measureTooltipElement = undefined;
                //     measureIndex++;
                //     createMeasureTooltip(map, measureIndex);
                // }
                // ol.Observable.unByKey(_listener);
            });
        }
        /**
         * Adds a tootip element containing meaurement info
         * @param  {Map} map
         * @param  {number} reloadId?
         */
        function createMeasureTooltip(map, reloadId) {
            _measureTooltipElement = document.createElement('div');
            _measureTooltipElement.className = 'ol-tooltip ol-tooltip-measure';
            _measureTooltip = new ol.Overlay({
                element: _measureTooltipElement,
                offset: [0, -15],
                id: reloadId,
                positioning: "bottom_left",
            });
            map.addOverlay(_measureTooltip);
        }
        /**
         * 建立文字內容
        */
        function measureText(text, cood, id) {
            let geom;
            _tooltipCoord = cood;

            if (_measureTooltipElement) {
                _measureTooltipElement.innerHTML = text;
                // console.log("measureText text :", _measureTooltipElement);
            }
            _measureTooltip.setPosition(_tooltipCoord);
            // console.log("measureText _tooltipCoord :", _tooltipCoord);

            if (_measureTooltipElement) {
                //evt.feature.setId(measureIndex);
                _measureTooltipElement.className = 'ol-tooltip ol-tooltip-static ';
                _measureTooltipElement.id = 'measure_' + id.toString();
                // console.log("measureText _measureTooltipElement.id : ", _measureTooltipElement.id);
                //_measureTooltip.setOffset([0, -7]);
                // unset this._sketch
                _sketch = null;
                // unset tooltip so that a new one can be created
                _measureTooltipElement = undefined;
                //jsonList.push(measureIndex);
                //measureIndex = jsonList[jsonList.length - 1];
                // if (id >= measureIndex) {
                //     measureIndex++;
                //     console.log("measureText", measureIndex);
                // }
                // console.log("measureIndex:", measureIndex);
                createTexttip([0, 0]);
            }
        }
        /**
         * 建立文字內容
        */
        function createTexttip(offset) {
            _measureTooltipElement = document.createElement('div');
            _measureTooltipElement.className = 'ol-tooltip ol-tooltip-measure';
            _measureTooltip = new ol.Overlay({
                element: _measureTooltipElement,
                offset: offset,
                id: measureIndex,
                positioning: "bottom_left",
            });
            map.addOverlay(_measureTooltip);
        }
        /**
         * Based on current annotation shape details,
         * adds annotation along with meaurement tooltip on isyntax file
         * @param  {Map} map
         * @param  {IAnnotationShape} currentShapeDetails
         */
        function toggleDrawMode(currentShapeDetails) {
            let geometryFn;
            resetInteractions();
            //map.removeInteraction(_draw);
            // console.log('reset intreactions in toggleDrawMode', map);
            _featureShape = currentShapeDetails;
            setMode(MODE.DRAW);
            switch (currentShapeDetails) {
                case AnnotationShapes.FreeformPolygon:
                    drawAnnotation('FreeformPolygon');
                    _draw = getDrawObjectForFeature('Polygon', true); // 定義圖形的形狀
                    map.addInteraction(_draw); // 畫圖
                    //createMeasureTooltip(map); // 找不出有差異的地方
                    measureShape(_draw, map); // 計算面積或長度，並顯示於介面
                    break;
                case AnnotationShapes.Polygon:
                    drawAnnotation('Polygon');
                    _draw = getDrawObjectForFeature('Polygon', false); // 定義圖形的形狀
                    map.addInteraction(_draw); // 畫圖
                    //createMeasureTooltip(map);
                    measureShape(_draw, map); // 計算面積或長度，並顯示於介面
                    break;
                case AnnotationShapes.Rectangle:
                    drawAnnotation('Rectangle');
                    geometryFn = ol.interaction.Draw.createBox(); // 畫圓形
                    _draw = getDrawObjectForFeature('Circle', false, geometryFn); // 定義圖形的形狀
                    map.addInteraction(_draw); // 畫圖
                    //createMeasureTooltip(map);
                    measureShape(_draw, map); // 計算面積或長度，並顯示於介面
                    break;
                case AnnotationShapes.Circle:
                    drawAnnotation('Circle');
                    geometryFn = ol.interaction.Draw.createRegularPolygon(90); // 畫長方形
                    _draw = getDrawObjectForFeature('Circle', false, geometryFn); // 定義圖形的形狀
                    map.addInteraction(_draw); // 畫圖
                    //createMeasureTooltip(map);
                    measureShape(_draw, map); // 計算面積或長度，並顯示於介面
                    break;
                case AnnotationShapes.Line:
                    drawAnnotation('Line');
                    geometryFn = ol.interaction.Draw.GeometryFunction
                    _draw = getDrawObjectForFeature('LineString', false, geometryFn); // 定義圖形的形狀
                    map.addInteraction(_draw); // 畫圖
                    //createMeasureTooltip(map);
                    measureShape(_draw, map); // 計算面積或長度，並顯示於介面
                    break;
                default:
                case AnnotationShapes.None:
                    map.removeInteraction(_draw);
                    break;
            }
            return map;
        }
        /**
         * Assigns the operation for annotation based on selected mode 刪除、選擇模式
         * @param  {string} mode Mode to perform the operations
         */
        function setAnnotationMode(mode) {
            switch (mode) {
                case MODE.EDIT:
                    map = editFeaturesMode(map);
                    break;
                case MODE.DELETE:
                    map = deleteFeaturesMode(map);
                    break;
                default:
                    break;
            }
        }
        /**
         * 取得文字id
         */
        function getTextId() {
            textidList = [];
            for (let ii = 0; ii < textCount; ii++) {
                try {
                    let valueId = document.getElementById("measure_" + ii);
                    textidList.push(parseInt(valueId.id.split('_')[1]));
                }
                catch { }
            }
            // console.log(textidList);
        }
        /**
         * 去除重複文字刪除事件聆聽器
         */
        function removeTextListener() {
            getTextId();
            for (let ii = 0; ii < textidList.length; ii++) {
                let el = document.getElementById("measure_" + textidList[ii]),
                    elClone = el.cloneNode(true);
                // console.log(el);
                el.parentNode.replaceChild(elClone, el);
            }

        }
        /**
         * 去除重複文字元素
         */
        function removeDuplicate() {
            let r = document.getElementsByClassName("ol-overlay-container ol-selectable");
            for (let i = 0; i < r.length; i++) {
                if (r[i].childNodes.length == 0) {
                    //console.log("没有子元素");
                    r[i].remove();
                }
                else {
                    if (r[i].childNodes[0].className == 'ol-tooltip ol-tooltip-measure') {
                        r[i].remove();
                    }
                    //console.log(r[i].childNodes[0].className);
                }
            }
        }
        /**
         * Deletes the selected annotation
         * @param  {Map} map
         */
        function deleteFeaturesMode(map) {
            //console.log("DF");
            resetInteractions(); //重整
            // 刪除文字內容
            classObj = document.getElementsByClassName("ol-tooltip ol-tooltip-static ");
            textCount = measureIndex;
            for (let i = 0; i < textCount; i++) {
                try {
                    let valueId = document.getElementById("measure_" + i);
                    // console.log(valueId);
                    valueId.removeEventListener("click", null);
                    valueId.addEventListener('click', function (evtt) {
                        try {
                            let clickId = evtt.toElement.id;
                            let clickIdObj = document.getElementById(clickId);
                            // console.log(clickId);
                            removeId(clickId.replace("measure_", ''), textList)
                            textJSON = textList
                            clickIdObj.parentNode.remove();
                            sendCase_imm()
                            refresh_note_list_text(textJSON);
                        }
                        catch { }
                        //jsonList = jsonList.filter(item => item !== parseInt(clickId.split('_')[1]));
                    });
                    // 當移動某個標註上面，highlight標註
                    valueId.addEventListener('mouseover', function (evt) {
                        //alert("123456789");
                        valueId.style.color = "#FF0000";
                    });
                    valueId.addEventListener('mouseout', function (evt) {
                        valueId.style.color = "#000000";
                    });
                }
                catch { }
            }
            // 刪除標註圖形
            _delete = new ol.interaction.Select();
            _delete.getFeatures().on('add', (feature) => {
                if (feature) {
                    // console.log(feature);
                    // console.log(feature.element);
                    vectorSource.removeFeature(feature.element);
                    feature.target.remove(feature.element);
                    //sendStatus = 'yes';
                    sendCase_imm();
                    //   const elementID = feature.element.getId();
                    //   const lineStringTooltip = document.getElementById('measure_' + elementID.toString());

                    //   if (lineStringTooltip && lineStringTooltip.parentNode) {
                    //     lineStringTooltip.parentNode.removeChild(lineStringTooltip);
                    //   }
                }
            });

            map.addInteraction(_delete);

            // 當移動某個標註上面，hightlight標註
            // _delete.getFeatures().on('mouseover', (feature) => {
            //     alert("12345678999999");
            //     let highlightStyle = new ol.style.Style({
            //         stroke: new ol.style.Stroke({
            //             color: feature_color,
            //             width: 5
            //         }),
            //         fill: new ol.style.Fill({
            //             //color: 'rgba(242,191,217,0.7)',
            //             color: 'rgba(155,178,249,0.7)',
            //         }),
            //     });
            //     feature.setStyle(highlightStyle);
            // });

            // let selectedStyle = new ol.style.Style({
            //     stroke: new ol.style.Stroke({
            //         width: 2,
            //         color: 'blue'
            //     }),
            //     fill: new ol.style.Fill()
            // });

            // let start;
            // _deleteSelect = new ol.interaction.Select({
            //     condition: ol.events.condition.pointerMove,
            //     style: function (feature) {
            //         let elapsed = new Date().getTime() - start;
            //         let opacity = Math.min(0.3 + elapsed / 10000, 0.8);
            //         selectedStyle.getFill().setColor('rgba(255,0,0,' + opacity + ')');
            //         feature.changed();
            //         return selectedStyle;
            //     }
            // });
            // _deleteSelect.on('select', function () {
            //     sendStatus = 'no'; // 預防圖層上標註變更後的即時儲存
            //     start = new Date().getTime();
            // });

            // map.addInteraction(_deleteSelect);

            //         let feature_onHover;
            // map.on('pointermove', function(evt) {
            //     let feature_color;
            //     feature_onHover = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            //         feature_color = feature.getProperties().hexCode;
            //         //console.log(feature);
            //         return feature;
            //       });

            //         let highlightStyle = new ol.style.Style({
            //                                     stroke: new ol.style.Stroke({
            //                                         color: feature_color,
            //                                         width: 5
            //                                     }),
            //                                     fill: new ol.style.Fill({
            //                                         //color: 'rgba(242,191,217,0.7)',
            //                                         color: 'rgba(155,178,249,0.7)',
            //                                     }),
            //                                 });
            //                                 let highlightStyle2 = new ol.style.Style({
            //                                     stroke: new ol.style.Stroke({
            //                                         color: feature_color,
            //                                         width: 3
            //                                     }),
            //                                     fill: new ol.style.Fill({
            //                                         color: 'rgba(255,255,255,0)',
            //                                     }),
            //                                 });
            //   if (feature_onHover) {
            //     feature_onHover.setStyle(highlightStyle);
            //   } 
            // });

            // map.on('pointerout', function(evt) {
            //     let feature_color;
            //     feature_onHover = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            //         feature_color = feature.getProperties().hexCode;
            //         console.log(feature);
            //         return feature;
            //       });

            //         let highlightStyle = new ol.style.Style({
            //                                     stroke: new ol.style.Stroke({
            //                                         color: feature_color,
            //                                         width: 5
            //                                     }),
            //                                     fill: new ol.style.Fill({
            //                                         //color: 'rgba(242,191,217,0.7)',
            //                                         color: 'rgba(155,178,249,0.7)',
            //                                     }),
            //                                 });
            //                                 let highlightStyle2 = new ol.style.Style({
            //                                     stroke: new ol.style.Stroke({
            //                                         color: feature_color,
            //                                         width: 3
            //                                     }),
            //                                     fill: new ol.style.Fill({
            //                                         color: 'rgba(255,255,255,0)',
            //                                     }),
            //                                 });
            //   if (feature_onHover) {
            //     feature_onHover.setStyle(highlightStyle2);
            //   } 
            // });

            return map;
        }
        /**
         * Activates the edit operation 圖形編輯
         * @param  {MouseEvent} event
         */
        function editAnnotation() {
            if (getCurrentIsyntaxImageName()) {
                isAnnotationElem = false;
                setMode(MODE.EDIT); // 改變模式
                // setFeatureStyles();
                // this.primengMessageService.add({
                //     severity: 'info',
                //     summary: this.translateService.instant(APP_CONSTANTS.EDIT_MODE) as string,
                //     detail: this.translateService.instant(APP_CONSTANTS.EDIT_ANNOTATION) as string,
                // });
                //const selectedElement = event.target;
                setAnnotationMode(MODE.EDIT);
            }
        }
        /**
         * 編輯文字內容
        */
        function editTextAnnotation() {
            let coord3857;
            let cood = '';
            let coordinate;

            // 滑鼠移動事件，抓點擊文字座標
            map.addEventListener('pointermove', function (evt) {
                coord3857 = evt.coordinate;
                //let  coord4326 = ol.proj.transform(coord3857, 'EPSG:3857', 'EPSG:4326');
                //console.log(coord3857);
            });
            classObj = document.getElementsByClassName("ol-tooltip ol-tooltip-static ");
            textCount = measureIndex;

            removeTextListener();
            // text calss listener
            for (let i = 0; i < textidList.length; i++) {

                let valueId = document.getElementById("measure_" + textidList[i]); // text id

                valueId.addEventListener('click', function (evtt) {
                    let clickId = evtt.toElement.id; // mouse click by id
                    let clickIdObj = document.getElementById(clickId);

                    removeId(clickId.replace("measure_", ''), textList)
                    textJSON = textList
                    //textJSON = textList
                    let index = textList.indexOf(parseInt(clickId.split('_')[1]));

                    cood = coord3857;
                    // console.log(cood);
                    try {
                        clickIdObj.parentNode.remove(); // remove old text
                        sendCase_imm()
                        // create html input
                        container = document.createElement('div');
                        container.setAttribute("id", "popup");
                        content = document.createElement("INPUT");
                        content.setAttribute("type", "text");
                        content.setAttribute("value", clickIdObj.textContent);
                        content.setAttribute("placeholder", "輸入");
                        content.setAttribute("id", 'popup-content');
                        container.appendChild(content);
                    }
                    catch { }

                    let overlay = new ol.Overlay(/** @type {olx.OverlayOptions} */({
                        element: container,
                        autoPan: true,
                        autoPanAnimation: {
                            duration: 250   // 當Popup超出地圖邊界時，為了Popup全部可見，地圖移動的速度. 單位為毫秒（ms）
                        }
                    }));

                    container.style = 'display:block';

                    let hdms = ol.coordinate.toStringHDMS(ol.proj.transform(
                        cood, 'EPSG:3857', 'EPSG:4326'));
                    overlay.setPosition(cood);
                    map.addOverlay(overlay);
                    //avoidDuplicate = true;
                    content.addEventListener('keydown', function (e) {

                        // hide on enter
                        if (e.keyCode === 13) {
                            //jsonList = jsonList.filter(item => item !== parseInt(clickId.split('_')[1])); // 移除已刪除的文字內容
                            createTexttip([-8, -8]); // 創建元素
                            measureText(content.value, cood, parseInt(clickId.split('_')[1])); // 計算面積或長度，並顯示於介面
                            settextjson(cood, parseInt(clickId.split('_')[1]), content.value);

                            try {
                                clickIdObj.remove();
                                content.remove();
                                container.remove();
                            }
                            catch { }
                            content.value = '';

                            let classObj = document.getElementsByClassName("ol-tooltip ol-tooltip-static ");
                            map.removeEventListener("pointermove", null);
                            removeTextListener();
                            //avoidDuplicate = false;
                            removeDuplicate(); // 去除重複文字元素

                            refresh_note_list_text(textJSON);

                            editTextAnnotation(); // 以達到連續編輯文字之功能
                        }
                    });
                });
            }
        }
        /**
         * Edits the selected annotation and recalculates the measuremnt info
         * @param  {Map} map
         */
        function editFeaturesMode(map) {
            let modifiedMeasureIndex;
            resetInteractions();

            sendStatus = 'edit';

            // 選取標註樣式設定
            let style_selected = new ol.style.Style({ //style to be added on selected layer
                fill: new ol.style.Fill({
                    color: '#5fba6a38',
                    opacity: 0
                }),
                stroke: new ol.style.Stroke({
                    color: 'red',
                    width: 3,
                    opacity: 1
                })
            });

            _select = new ol.interaction.Select({
                style: null,
            });
            map.addInteraction(_select);

            _modify = new ol.interaction.Modify({
                features: _select.getFeatures(),
                style: null,
            });

            // _modify.on('modifystart', (evt) => {
            // _sketch = evt.features.item(0);
            // modifiedMeasureIndex = Number(_sketch.getId());
            // _measureTooltip = map.getOverlayById(modifiedMeasureIndex);
            // _measureTooltipElement = _measureTooltip.getElement();
            // _measureTooltipElement.className = 'tooltip tooltip-measure';

            // let tooltipCoord;
            // _listener = _sketch.getGeometry().on('change', (event) => {
            //     const geom = event.target;
            //     let output;
            //     if (geom instanceof LineString && scale && _measureTooltipElement) {
            //     // output = formatLength(geom, scale);
            //     // _measureTooltipElement.innerHTML = output;
            //     tooltipCoord = geom.getLastCoordinate();
            //     } 
            //     else if (geom instanceof Polygon && scale && _measureTooltipElement) {
            //     // output = formatArea(geom, scale);
            //     // _measureTooltipElement.innerHTML = output;
            //     tooltipCoord = geom.getFirstCoordinate();
            //     }
            //     _measureTooltip.setPosition(tooltipCoord);
            // });
            // });

            // _modify.on('modifyend', () => {
            // if (_measureTooltipElement) {
            //     // _measureTooltipElement.className = 'ol-tooltip ol-tooltip-static ';
            //     _sketch = null;
            //     _measureTooltipElement = undefined;
            //     _measureTooltip = map.getOverlayById(modifiedMeasureIndex);
            // }
            // unByKey(_listener);
            // });

            map.addInteraction(_modify);
            _snap = new ol.interaction.Snap({
                source: vectorLayer.getSource(),
                style: null,
            });
            map.addInteraction(_snap);
            return map;
        }
        /**
         * Returns a Draw object for feature to draw the annotations on map
         * @param  {GeometryType} feature
         * @param  {boolean} isFreeform
         * @param  {GeometryFunction} geometryFn?
         */
        function getDrawObjectForFeature(feature, isFreeform, geometryFn) {
            const drawOptions = {
                source: vectorLayer.getSource(),
                type: feature, // 特徵類別，區分為三種，詳見175行程式碼
                geometryFunction: geometryFn, // 幾何圖形畫完存取
                freehand: isFreeform,
                // condition: function(e) { // 滑鼠左鍵移動玻片不畫圖，右鍵畫標註圖形
                //     if (e.pointerEvent.buttons === 2) {
                //         return true;
                //     } else {
                //         return false;
                //     }
                // }
            };
            // console.log(drawOptions);
            return new ol.interaction.Draw(drawOptions);
        }
        /**
         * Returns the current Isyntax file location/path
         */
        function getCurrentFileLocation() {
            return _currentIsyntaxImageLocation;
        }
        /**
         * Looks for any annotations file associated with the current Isyntax image，從json檔中讀取此圖的標示
         */
        /* function readFeaturesFromDisk() {
            return axios.
                get(API_URL + "8088" + '/shapes?host=' + caseName, {
                    responseType: 'any',
                    headers: {
                        'x-access-token': token
                    }
                }); */
        // // return this.http.get(annotationsFilePath);
        // if (this.electronService.isElectronApp) {
        // const annotations = this.electronService.ipcRenderer.sendSync('loadAnnotations', [annotationsFilePath]);
        // return of(annotations);
        // }
        // }
        /**
         * Returns a new vector layer
         * @param  {VectorSource} vectorSource
         */
        function createVectorLayer(vectorSource) {
            const layerOptions = {
                source: vectorSource,
                wrapX: false,
            };
            return new ol.layer.Vector(layerOptions);
        }
        /**
         * Toggles show/hide of annotations(標註圖形) on vector layer(畫圖形層) based on the value given
         * @param  {boolean} showAnnotations
         */
        function toggleAnnotations(showAnnotations) {
            vectorLayer.setVisible(showAnnotations);
        }
        /**
         * Returns a new vector source
         */
        function createVectorSource() {
            return new ol.source.Vector({
                wrapX: false,
                features: new ol.format.GeoJSON({
                    featureProjection: 'EPSG:3857',
                }).readFeatures(_geojsonObject),
            });
        }
        /**
         * Initializes the vectorlayer/ vectorSource for map
         * @param  {Map} map
         */
        function createVector(map) {
            vectorSource = createVectorSource();
            //console.log(vectorSource);
            vectorLayer = createVectorLayer(vectorSource);
            setFeatureStyles();
            watchVectorSourceChanges();
            map.addLayer(vectorLayer);
            //toggleAnnotations(_showAnnotations);
            //calculateMeasurementInfo(map);
            return map;
        }
        /**
         * Adds existing text on tile Layer(標註層) of isyntax file
         */
        function addLayerForText(jsonfile) {
            if (jsonfile != null && jsonfile != undefined && jsonfile.length != 0) {
                for (let i = 0; i < jsonfile.length; i++) {
                    textList.push(jsonfile[i])
                    try {
                        createTexttip([0, 0]); // 創建元素
                        measureText(jsonfile[i]["value"], jsonfile[i]["coordinates"][0][0], jsonfile[i]["id"]);
                        //container.parentNode.remove();
                    }
                    catch {
                        console.log("addLayerForText : create error");
                    }
                }
            } else { console.log("addLayerForText : JSON is null"); }
        }
        /**
         * 更新圖層文字部分
         */
        function refresh_note_list_text(jsonfile) {
            if (jsonfile != null && jsonfile != undefined && jsonfile.length != 0) {
                let cont2 = $('#nnp_text'); //David_20100525
                let cont3 = $('#nnpp_text'); //David_20100527

                cont2.attr('id', 'text_0'); //David_20100525
                cont2.val('#000000'); //David_20100525
                cont3.html('文字'); //David_20100527

                $('#note_private_text').css('display', ''); //David_20210521
                $('#note_private_text .layer_color div').css('background', '#000000'); //David_20210521
                $('#note_private_text .layer_color').attr({ 'data-color': '#000000', 'data-colorlabel': '文字' }); //David_20210521

                let htmlStr = "";

                for (let i = 0; i < jsonfile.length; i++) {
                    let id_2 = jsonfile[i]["id"];
                    let value_1 = jsonfile[i]["value"];
                    let value_2 = "";

                    if ($("#" + id_2 + "_1").length > 0) {
                        value_2 = "" + document.getElementById(id_2 + "_1").value;
                    }

                    htmlStr += '<div class="table_tr_d note_public" id="note_public_sub' + i + '" style="width: 100%;">' +
                        '<div class="t1" style="width: 22%;">' +
                        '<input id="' + id_2 + '" type="hidden" class="" value="' + '#000000' + '">' +
                        '<input id="' + id_2 + '_1" type="hidden" class="" value="' + value_2 + '">' +
                        '</div>';
                    if (value_2 == "")
                        htmlStr += '<div class="t2" id="' + id_2 + '" style="width: 25%;">';
                    else
                        htmlStr += '<div class="t2 layer_click_focus" id="' + id_2 + '" style="width: 25%;">';
                    htmlStr += '<span>' + value_1 + '</span>' +
                        '</div>' +
                        '<div class="layer_d_click" style="width: 53%;">' +
                        '<div class="t3" style="width: 84%;"></div>' +
                        '<div class="t4" id="' + id_2 + '" value="' + value_1 + '" style="width: 16%;">' +
                        '<button type="button" class="tran_btn p-0 pr-1">' +
                        '<i class="far fa-trash-alt"></i>' +
                        '</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                    if (htmlStr != "")
                        htmlStr = '<div style="width: 100%; display: block;">' + htmlStr + '</div>';

                    let cont = $('#nn_text');
                    let cont_2 = $('#note_private_sb_text');


                    if (jsonfile.length > 0) {
                        cont.html("數量：" + jsonfile.length);
                    } else {
                        cont.html("");
                    }
                    cont_2.html(htmlStr);


                }
            }
            else {
                $('#note_private_sb_text').css('display', 'none');
                $('#note_private_text').css('display', 'none');
                console.log("refresh_note_list_text : TEXT JSON is null");
            }
            note_list_delete_text();
        }
        /**
         * 刪除圖層文字部分所有選項
         */
        function note_list_delete_alltext() {
            let obj = textList;

            for (let l = 0; l < obj.length; l++) {
                let valueId = document.getElementById("measure_" + obj[l]["id"]);
                let clickIdObj = valueId;

                removeId(obj[l]["id"], textList)
                textJSON = textList
                clickIdObj.parentNode.remove();
            }

            textJSON = [];

            sendCase_imm()
            refresh_note_list_text(textJSON);
            $('#show_all_layer').prop('checked', false);
            $('#show_all_layer').prop('checked', true);
        }
        /**
         * 控制圖層文字部分顯示或隱藏
         */
        function note_list_text_eye_ctrl(state) {
            let obj = textList;
            for (let l = 0; l < obj.length; l++) {
                let valueId = document.getElementById("measure_" + obj[l]["id"]);
                // console.log(valueId,obj[l]["id"]);

                if (state == 'open') {
                    valueId.style.display = "block";
                }
                else {
                    valueId.style.display = "none";
                }
            }
        }
        /**
         * 刪除圖層文字部分子選項
         * 選取標註
         */
        function note_list_delete_text() {
            $('#note_private_sb_text .note_public .t4').unbind("click").bind("click", async function () {
                let check = await delete_note_alert2() // 刪除按鈕提醒
                if (check) {
                    let note_id = $(this)[0].id;
                    let valueId = document.getElementById("measure_" + note_id);
                    let clickIdObj = valueId

                    removeId(note_id, textList)

                    textJSON = textList

                    clickIdObj.parentNode.remove();
                    sendCase_imm()
                    refresh_note_list_text(textJSON);
                    $('#show_all_layer').prop('checked', false);
                    $('#show_all_layer').prop('checked', true);
                }
            })
        }
        /**
         * 新增快捷鍵，按下ESC時將功能切換至選取狀態
         */
        function addEscListener() {
            document.addEventListener('keydown', function (event) {
                if (event.key === "Escape" && esctouch == true) {
                    $('.point_btn').click(); // 切換至選取狀態
                    // map.events.triggerEvent("click");
                    // $('.text_btn').classList.remove("hasactive");
                    //tools.MouseMode(painterApp);
                    // draw end
                    // if (measureIndex == 0) {
                    //     measureIndex = localStorage.getItem("id") != null ? localStorage.getItem("id") : 0;
                    // }
                    // console.log("new feature ID:", measureIndex);

                    // 保存尚未畫完之標註圖形
                    //console.log(feature_geom.flatCoordinates);
                    const feature_array = new Array(0); // 宣告空array
                    for (let i = 0; i < feature_geom.flatCoordinates.length; i += 2) {
                        let temp_cood = [feature_geom.flatCoordinates[i], feature_geom.flatCoordinates[i + 1]]; // 兩兩一組
                        temp_cood = ol.proj.transform(temp_cood, 'EPSG:3857', 'EPSG:4326'); // 兩兩一組轉換標註座標(使用EPSG:3857，標註會介於X: 0~1，Y: 0~-1)
                        feature_array.push(temp_cood);
                    }

                    // console.log(feature_array);
                    //console.log(feature_geom.flatCoordinates.transform('EPSG:3857', 'EPSG:4326'));
                    // feature_geom.setId(measureIndex); // 設定圖形json id
                    // measureIndex++;
                    // 
                    // {"type":"FeatureCollection","features":[{"type":"Feature","id":0,"geometry":{"type":"Polygon","coordinates":[[[0.7644160572745072,-0.32609391626999695],[0.8288072968401946,-0.32609391626999695],[0.8288072968401946,-0.25434457496180585],[0.7644160572745072,-0.25434457496180585],[0.7644160572745072,-0.32609391626999695]]]},"properties":{"hexCode":"#ff0000","geometryShape":"Rectangle"}}]}
                    // {"type":"FeatureCollection","features":[{"type":"Feature","id":1,"geometry":{"type":"Polygon","coordinates":[[[1.0201412939077323,-0.28929945345352337],[1.023262878639655,-0.2830229540525693],[1.0259390274214184,-0.27654399229963644],[1.0281567023251637,-0.2698941328189193],[1.0299050990616794,-0.2631057728900572],[1.0311756996178134,-0.2562119846138273],[1.0319623137553768,-0.24924635378829407],[1.0322611091693614,-0.24224281628092115],[1.0320706301585454,-0.2352354926938176],[1.0313918047175221,-0.22825852212767472],[1.0302279400156054,-0.22134589585456865],[1.0285847062846312,-0.21453129170998864],[1.02647010919416,-0.20784791001162262],[1.0238944508486576,-0.20132831180377764],[1.0208702795966795,-0.1950042602162938],[1.0174123288965764,-0.18890656571072384],[1.013537445536567,-0.18306493596830364],[1.00926450755888,-0.17750783115037905],[1.004614332287828,-0.17226232523779572],[0.9996095749098978,-0.1673539741235004],[0.9942746180999579,-0.16280669110233248],[0.9886354532313184,-0.15864263036377224],[0.9827195537483727,-0.1548820790554828],[0.9765557413187375,-0.15154335844383127],[0.9701740454169857,-0.14864273465222766],[0.9636055570240648,-0.1461943394127445],[0.9568822771551629,-0.14421010121637323],[0.9500369609539797,-0.1426996871980748],[0.9431029581129584,-0.1416704560386819],[0.936114050396937,-0.14112742211395357],[0.9291042870617857,-0.14107323106486547],[0.9221078189698539,-0.14150814690819402],[0.9151587322104033,-0.14243005075020676],[0.908290882035606,-0.14383445110982507],[0.90153772792116,-0.14571450580086776],[0.894932170555086,-0.1480610552666377],[0.8885063915488831,-0.15086266720497576],[0.8822916966519528,-0.15410569226594362],[0.8763183632331338,-0.15777433055127688],[0.8706154927724051,-0.1618507085912313],[0.8652108690814012,-0.16631496642452248],[0.8601308229434735,-0.17114535435652556],[0.8554001038327614,-0.17631833892481552],[0.8510417593372424,-0.1818087175557963],[0.8470770228731993,-0.18758974135360518],[0.843525210238151,-0.19363324542320015],[0.8404036255062283,-0.1999097860928032],[0.8377274767244648,-0.20638878436678],[0.8355098018207198,-0.2130386749101092],[0.833761405084204,-0.21982705983850792],[0.8324908045280698,-0.22672086656463364],[0.8317041903905064,-0.2336865089313136],[0.8314053949765218,-0.24069005084645312],[0.8315958739873378,-0.24769737162210959],[0.8322746994283611,-0.2546743322123888],[0.8334385641302778,-0.26158694153936324],[0.835081797861252,-0.2684015220973066],[0.8371963949517233,-0.27508487402768367],[0.8397720532972255,-0.28160443686559233],[0.8427962245492037,-0.28792844816963736],[0.8462541752493068,-0.2940260982622931],[0.850129058609316,-0.29986768032681255],[0.8544019965870032,-0.3054247351298187],[0.8590521718580553,-0.31067018966399473],[0.8640569292359854,-0.3155784890363549],[0.8693918860459255,-0.3201257209591972],[0.8750310509145648,-0.3242897322376308],[0.8809469503975105,-0.3280502366866358],[0.8871107628271457,-0.33138891395191195],[0.8934924587288975,-0.3342894987537335],[0.9000609471218184,-0.33673786011895857],[0.9067842269907201,-0.33872207021586576],[0.9136295431919036,-0.3402324624564699],[0.9205635460329248,-0.34126167858374856],[0.9275524537489462,-0.3418047045145727],[0.9345622170840975,-0.3418588947635186],[0.9415586851760294,-0.34142398532945606],[0.9485077719354799,-0.34050209498128936],[0.9553756221102772,-0.33909771493749474],[0.9621287762247231,-0.33721768698883636],[0.9687343335907972,-0.33487117017149615],[0.9751601125970001,-0.3320695961521807],[0.9813748074939304,-0.3288266135427165],[0.9873481409127495,-0.32515802141517725],[0.9930510113734781,-0.3210816923408686],[0.9984556350644821,-0.3166174853279955],[1.0035356812024097,-0.31178714908207894],[1.0082664003131216,-0.30661421605948647],[1.012624744808641,-0.301123887830542],[1.016589481272684,-0.29534291231009036],[1.0201412939077323,-0.28929945345352337]]]},"properties":{"hexCode":"#ff0000","geometryShape":"Circle"}}]}
                    // {"type":"FeatureCollection","features":[{"type":"Feature","id":2,"geometry":{"type":"Polygon","coordinates":[[[0.8619227072569187,-0.25434457496180585],[0.9410320005823255,-0.31873500590782555],[0.7441788386262154,-0.41072061736295495],[0.7404992550054039,-0.22490886556603584],[0.834326461728767,-0.22306908781443724],[0.8619227072569187,-0.25434457496180585]]]},"properties":{"hexCode":"#ff0000","geometryShape":"Polygon"}}]}
                    // {"type":"FeatureCollection","features":[{"type":"Feature","id":4,"geometry":{"type":"Polygon","coordinates":[[[0.782813554293275,-0.22306908781443724],[0.782813554293275,-0.22306908781443724],[0.7864929975523234,-0.22490886556603584],[0.792012302802659,-0.23410754026670588],[0.7956917460617072,-0.23962672816982433],[0.7993713296825187,-0.24514591384939877],[0.8012110513120428,-0.2506650972542275],[0.803050772941567,-0.25434457496180585],[0.8048904945710912,-0.25986375446159116],[0.8067302162006154,-0.26538293155009285],[0.8085700781919026,-0.2709021763561452],[0.8104097998214268,-0.27458157792668203],[0.812249521450951,-0.2801008185146827],[0.812249521450951,-0.2856199863235247],[0.812249521450951,-0.2911391514820707],[0.812249521450951,-0.2911391514820707],[0.812249521450951,-0.2984980809355591],[0.812249521450951,-0.2984980809355591],[0.812249521450951,-0.30585693528504976],[0.8104097998214268,-0.31137609028769475],[0.8085700781919026,-0.3132158547689414],[0.8067302162006154,-0.3150555487474236],[0.8067302162006154,-0.3150555487474236],[0.803050772941567,-0.31873500590782555],[0.7993713296825187,-0.3205746989061282],[0.7938520244321832,-0.3224144617537519],[0.7883327191818476,-0.3224144617537519],[0.7864929975523234,-0.3242541540891324],[0.782813554293275,-0.3242541540891324],[0.782813554293275,-0.3242541540891324],[0.7772942490429394,-0.3242541540891324],[0.771775084154367,-0.3224144617537519],[0.7662557789040314,-0.3205746989061282],[0.7625763356449832,-0.31873500590782555],[0.7570570303946476,-0.31689531258089687],[0.7515377251443119,-0.3150555487474236],[0.7460185602557394,-0.31137609028769475],[0.7404992550054039,-0.30769670072371014],[0.7368198117463556,-0.3021774736434537],[0.73130050649602,-0.296658313939119],[0.7276210632369717,-0.2911391514820707],[0.7239414796161602,-0.2856199863235247],[0.7184223147275878,-0.27826104854491973],[0.7165825930980636,-0.2709021763561452],[0.7147427311067763,-0.2672227034882866],[0.7129030094772522,-0.25986375446159116],[0.711063287847728,-0.25250487132829846],[0.7092235662182039,-0.24514591384939877],[0.7092235662182039,-0.23962672816982433],[0.7092235662182039,-0.23962672816982433],[0.7092235662182039,-0.2359472464182204],[0.7092235662182039,-0.2359472464182204],[0.782813554293275,-0.22306908781443724]]]},"properties":{"hexCode":"#ff0000","geometryShape":"FreeformPolygon"}}]}
                    //let lonlat = ol.proj.transform(cars, 'EPSG:3857', 'EPSG:4326');
                    //console.log(lonlat);
                    // 人工json
                    let ff = {
                        "type": "FeatureCollection",
                        "features": [{
                            "type": "Feature",
                            "id": measureIndex,
                            "geometry": {
                                "type": "Polygon",
                                "coordinates": [feature_array]
                            },
                            "properties": {
                                "hexCode": getColorForFeature(),
                                "geometryShape": getShapeForFeature()
                            }
                        }]
                    };
                    measureIndex++;
                    // hexCode: getColorForFeature(),
                    // geometryShape: getShapeForFeature(),

                    // 從json讀取轉換標註
                    featuresss = new ol.format.GeoJSON({
                        featureProjection: 'EPSG:3857',
                    }).readFeatures(ff);
                    vectorLayer.getSource().addFeatures(featuresss); // 加入標註於頁面


                    addEscListener();
                }
            });
        }
        /**
         * Adds existing annotations on tile Layer(標註層) of isyntax file
         * @param  {Map} map
         */
        function addLayerForFeatures(map) {
            annotations = JSON.parse(localStorage.getItem("featuresJson"));
            textJSON = JSON.parse(localStorage.getItem("textJSON"));
            _geojsonObject = annotations ? annotations : initializeFeatureGeoJSON();
            //console.log(localStorage.getItem("featuresJson"));
            //console.log(_geojsonObject);
            map = createVector(map);
            featureJSON = annotations ? JSON.stringify(annotations) : JSON.stringify(initializeFeatureGeoJSON());
            this.writeFeaturesToSessionStorage(JSON.stringify(annotations));
            addLayerForText(textJSON); // 添加文字於layer
            refresh_note_list_text(textJSON); // 圖層新增文字部分
            note_list_delete_text(); // 圖層刪除文字功能
            $('.point_btn').click(); // 進入頁面時預設為選取功能
            setThemeIconColor(initcolor); // 標註畫筆初始為第一個共用類別
        }
        /**
         * Adds Image Info label control to map to show resolution and zoom level 畫布左下縮放倍率訊息顯示
         */
        function addImageInfoLabelControl() {
            imageInfoLabel = document.createElement('div');
            imageInfoLabel.className = 'ol-control-panel ol-unselectable ol-control image-info-label';
            imageInfoLabel.id = 'zoomMsg';

            const imageInfoControl = new ol.control.Control({
                element: imageInfoLabel,
            });
            return imageInfoControl;
        }
        /**
         * Activates the delete operation
         * @param  {MouseEvent} event
         */
        function deleteAnnotation() {
            //resetInteractions(map);
            //console.log("********-----------");
            if (getCurrentIsyntaxImageName()) {
                //console.log("DA");
                isAnnotationElem = false;
                setMode(MODE.DELETE);
                //setFeatureStyles();
                // this.primengMessageService.add({
                // severity: 'info',
                // summary: this.translateService.instant(APP_CONSTANTS.DELETE_MODE),
                // detail: this.translateService.instant(APP_CONSTANTS.DELETE_ANNOTATION),
                // });
                const selectedElement = event.target;
                setAnnotationMode(MODE.DELETE);
                //highlightSelectedOrientation(selectedElement);
            }
        }
        /**
         * Creates layer and map for current isyntax image
         * @param  {string} urlValue The url for current Isyntax image
         */
        function renderViewer(urlValue) {
            if (urlValue) {
                const fileLocation = urlValue;
                FILE_LOCATION.PATH = fileLocation;
                // console.log(fileLocation);
                // console.log(FILE_LOCATION.PATH);
                //setCurrentFileLocation(fileLocation);
                const fileName = urlValue.slice(Number(urlValue.lastIndexOf('\\')) + 1, urlValue.length - 1);
                setCurrentIsyntaxImageName(fileName);

                // if (_layer && _layer.getSource) {		
                // 	console.log("**");
                // 	this._layer.getSource().refresh();
                // 	this._layer.getSource().clear();
                // }

                const caseLevelList = Promise.resolve(getLevelList());
                caseLevelList.then(function (data) {
                    series.LevelData = data.data;
                    series.TotalHeight = data.data[0][1][2];
                    series.TotalWidth = data.data[0][0][2];
                    series.Resolutions = [];
                    for (let i = 0; i < Object.keys(data.data).length; i++) {
                        const factor = Math.pow(2, i);
                        series.Resolutions.push(factor);
                    }
                    width = series.TotalWidth;
                    height = series.TotalHeight;
                    countLevels = series.Resolutions.length;
                    localStorage.setItem('size', JSON.stringify({ width, height }));

                    const proj = new ol.proj.Projection({
                        code: 'pixel',
                        units: 'pixels',
                        extent: [0, 0, width, height],
                    });

                    const extent = [0, -height, width, 0];

                    const caseScale = Promise.resolve(getScale());
                    caseScale.then(function (scaleData) {
                        scale = getScaleData(scaleData.data);
                        _layer = createLayer(extent, proj, fileLocation, scale); // fileLocation: 圖片路徑，
                        wireLayerEvents(_layer);

                        map = createMap(proj, ol.nteraction);
                        const size = map.getSize();
                        map.getView().fit(extent, { size });
                        //spinnerOverlayService.hide(); // 隱藏loading畫面
                    })
                });
                imageonload = true;
                //console.log(imageonload);
            }
            // console.log('imageonload');
            let interactions = [

                new ol.interaction.KeyboardPan({
                    pixelDelta: 256
                }),
            ];
        }
        let selectInteraction = new ol.interaction.Select({
            condition: ol.events.condition.click,
            wrapX: false
        });
        let modifyInteraction = new ol.interaction.Modify({
            features: selectInteraction.getFeatures()
        });
        let setActiveEditing = function (active) { // active: true: 編輯圖形， false: 畫圖
            selectInteraction.getFeatures().clear(); // 清除尚未畫完成的標註圖形
            selectInteraction.setActive(active);
            modifyInteraction.setActive(active);
            translateInteraction.setActive(active);
        };

        document.querySelectorAll(".__range-step").forEach(function (ctrl) {
            let el = ctrl.querySelector('input');
            let output = ctrl.querySelector('output');
            let newPoint, newPlace, offset;
            el.oninput = function () {
                // colorize step options
                ctrl.querySelectorAll("option").forEach(function (opt) {
                    if (opt.value <= el.valueAsNumber)
                        opt.style.backgroundColor = 'white';
                    else
                        opt.style.backgroundColor = '#aaa';
                });
                // colorize before and after
                let valPercent = (el.valueAsNumber - parseInt(el.min)) / (parseInt(el.max) - parseInt(el.min));
                let style = 'background-image: -webkit-gradient(linear, 0% 0%, 100% 0%, color-stop(' +
                    valPercent + ', white), color-stop(' +
                    valPercent + ', #aaa));';
                el.style = style;

                // Popup
                if ((' ' + ctrl.className + ' ').indexOf(' ' + '__range-step-popup' + ' ') > -1) {
                    let selectedOpt = ctrl.querySelector('option[value="' + el.value + '"]');
                    output.innerText = selectedOpt.text;
                    output.style.left = "50%";
                    output.style.left = ((selectedOpt.offsetLeft + selectedOpt.offsetWidth / 2) - output.offsetWidth / 2) + 'px';
                }
            };
            el.oninput();
        });

        window.onresize = function () {
            document.querySelectorAll(".__range").forEach(function (ctrl) {
                let el = ctrl.querySelector('input');
                el.oninput();
            });
        };

        document.querySelectorAll(".__range-step").forEach(function (ctrl) {
            let el = ctrl.querySelector('input');
            let output = ctrl.querySelector('output');
            let newPoint, newPlace, offset;
            el.oninput = function () {
                // colorize step options
                ctrl.querySelectorAll("option").forEach(function (opt) {
                    if (opt.value <= el.valueAsNumber)
                        opt.style.backgroundColor = 'white';
                    else
                        opt.style.backgroundColor = '#aaa';
                });
                // colorize before and after
                let valPercent = (el.valueAsNumber - parseInt(el.min)) / (parseInt(el.max) - parseInt(el.min));
                let style = 'background-image: -webkit-gradient(linear, 0% 0%, 100% 0%, color-stop(' +
                    valPercent + ', white), color-stop(' +
                    valPercent + ', #aaa));';
                el.style = style;

                // Popup
                if ((' ' + ctrl.className + ' ').indexOf(' ' + '__range-step-popup' + ' ') > -1) {
                    let selectedOpt = ctrl.querySelector('option[value="' + el.value + '"]');
                    output.innerText = selectedOpt.text;
                    output.style.left = "50%";
                    output.style.left = ((selectedOpt.offsetLeft + selectedOpt.offsetWidth / 2) - output.offsetWidth / 2) + 'px';
                }
            };
            el.oninput();
        });

        window.onresize = function () {
            document.querySelectorAll(".__range").forEach(function (ctrl) {
                let el = ctrl.querySelector('input');
                el.oninput();
            });
        };

        //控制開關
        $(function () {
            $.fn.toggleAttrVal = function (attr, val1, val2) {
                let test = $(this).attr(attr);
                if (test === val1) {
                    $(this).attr(attr, val2);
                    return this;
                }
                if (test === val2) {
                    $(this).attr(attr, val1);
                    return this;
                }
                // default to val1 if neither
                $(this).attr(attr, val1);
                return this;
            };
            $(".menu").click(function () {
                $(".toolbar").toggle();
                $(".menu button").toggleClass('close_menu')
                $(".tool_BG").toggleClass('BGtransparent');
                $(".edit").hide();
                $(".square").hide();
                $(".zoom").hide();
            });

            $(".icon-edit-pencil").click(function () {
                $(".edit").toggle("slow");
                $(".square").hide();
                $(".zoom").hide();
            });

            $(".icon-square").click(function () {
                $(".square").toggle("slow");
                $(".edit").hide();
                $(".zoom").hide();
            });

            $(".icon-search").click(function () {
                $(".zoom").toggle("slow");
                $(".square").hide();
                $(".edit").hide();
            });

            $(".point_btn").click(function () {
                $(".point_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                $('.fa-mouse-pointer').addClass('used_button_img');
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');
                //不亮起的部分
                $(".text_btn img:first").attr('src', './img/icon/btn_text.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)+ .slide_right').hide();
                $("#painter_app").removeClass('cursor_move cursor_clear cursor_sacle cursor_pen');
            });

            $(".pen_btn").click(function () {
                $(".pen_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');

                //亮不亮起的部分
                $('.fa-mouse-pointer').removeClass('used_button_img');
                $(".text_btn img:first").attr('src', './img/icon/btn_text.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen_c.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');
                $(".pen_d ").toggle();
                if (!$(".pen_d ").is(':hidden')) {
                    $(".color_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                    $(".color_btn img").attr('src', './img/icon/btn_Color_c.png')
                    $(".color_d").show();
                    $("#color_public1").addClass('now_color');
                }
                $('.toolbar_btn:not(.fix_function)+ .slide_right').not($('.pen_d')).hide();

                $("#painter_app").addClass('cursor_pen').removeClass('cursor_move cursor_clear cursor_sacle');
            });

            $(".pen_btn_d").click(function () {
                $(this).addClass('used_button now_pen').attr('data-nowfunc', 'now_func_d');
                if ($(".pen_btn").attr('data-nowfunc') == 'now_func') {
                    // console.log($(this).attr('id'));
                }
                $('.pen_btn_d').not($(this)).removeClass('used_button  now_pen').removeAttr('data-nowfunc');

            });

            $(".clear_btn").click(function () {
                $(".clear_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                //亮不亮起的部分
                $('.fa-mouse-pointer').removeClass('used_button_img');
                $(".text_btn img:first").attr('src', './img/icon/btn_text.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear_c.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');
                $('.toolbar_btn:not(.fix_function)+ .slide_right').hide();
                $("#painter_app").addClass('cursor_clear').removeClass('cursor_move cursor_sxcle cursor_pen');
            });

            $(".move_btn").click(function () {
                $(".move_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                //亮不亮起的部分
                $('.fa-mouse-pointer').removeClass('used_button_img');
                $(".text_btn img:first").attr('src', './img/icon/btn_text.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move_c.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');
                $('.toolbar_btn:not(.fix_function)+ .slide_right').hide();
                $("#painter_app").addClass('cursor_move').removeClass('cursor_clear cursor_sacle cursor_pen');
            });

            $(".text_btn").click(function () {
                $(".text_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                //亮不亮起的部分
                $('.fa-mouse-pointer').removeClass('used_button_img');
                $(".text_btn img:first").attr('src', './img/icon/btn_text_c.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');
                $('.toolbar_btn:not(.fix_function)+ .slide_right').hide();
                $("#painter_app").removeClass('cursor_move cursor_clear cursor_sacle cursor_pen');
            });

            $(".sacle_btn").click(function () {
                $(".sacle_btn").addClass('used_button now_func').attr('data-nowfunc', 'now_func');
                $(".sacle_d").toggle();

                $("#painter_app").addClass('cursor_sacle').removeClass('cursor_move cursor_clear  cursor_pen');
                //亮不亮起的部分
                $('.fa-mouse-pointer').removeClass('used_button_img');
                $(".text_btn img:first").attr('src', './img/icon/btn_text.png');
                $(".clear_btn img:first").attr('src', './img/icon/btn_clear.png');
                $(".sacle_btn img:first").attr('src', './img/icon/btn_sacle_c.png');
                $(".move_btn img:first").attr('src', './img/icon/btn_move.png');
                $(".pen_btn img:first").attr('src', './img/icon/btn_pen.png');
                //不亮起的部分//
                $('.toolbar_btn:not(.fix_function)').not($(this)).removeClass('used_button now_func').removeAttr('data-nowfunc');

                $('.toolbar_btn:not(.fix_function)+ .slide_right').not($('.sacle_d')).hide();
            });

            $(".view_btn").click(function () {
                $(".view_btn").toggleClass('used_button');
                $(".view_btn img").toggleAttrVal('src', './img/icon/btn_view.png', './img/icon/btn_view_c.png')
                $(".ol-overviewmap.ol-unselectable.ol-control").toggle();
            });

            $(document).on('click', ".note_public .t2", function () { //David_20210524
                let id = this.id;
                let timer = id.replace("note_public_t2_", "");
                let display = $('#note_public_sp' + timer + '').css('display');

                if (display == "none") {
                    $('#note_public_sp' + timer + '').css('display', '');
                    $('#note_public_sb' + timer + '').css('display', '');
                } else {
                    $('#note_public_sp' + timer + '').css('display', 'none');
                    $('#note_public_sb' + timer + '').css('display', 'none');
                }
            });

            $(document).on('click', ".note_public .t3", function () { //David_20210524
                let id = this.id;
                let timer = id.replace("note_public_t3_", "");
                let display = $('#note_public_sp' + timer + '').css('display');

                if (display == "none") {
                    $('#note_public_sp' + timer + '').css('display', '');
                    $('#note_public_sb' + timer + '').css('display', '');
                } else {
                    $('#note_public_sp' + timer + '').css('display', 'none');
                    $('#note_public_sb' + timer + '').css('display', 'none');
                }
            });

            $(document).on('click', ".note_private .t2", function () { //David_20210524
                let id = this.id;
                let timer = id.replace("note_private_t2_", "");
                let display = $('#note_private_sp' + timer + '').css('display');

                if (display == "none") {
                    $('#note_private_sp' + timer + '').css('display', '');
                    $('#note_private_sb' + timer + '').css('display', '');
                } else {
                    $('#note_private_sp' + timer + '').css('display', 'none');
                    $('#note_private_sb' + timer + '').css('display', 'none');
                }
            });

            $(document).on('click', ".note_private .t3", function () { //David_20210524
                let id = this.id;
                let timer = id.replace("note_private_t3_", "");
                let display = $('#note_private_sp' + timer + '').css('display');

                if (display == "none") {
                    $('#note_private_sp' + timer + '').css('display', '');
                    $('#note_private_sb' + timer + '').css('display', '');
                } else {
                    $('#note_private_sp' + timer + '').css('display', 'none');
                    $('#note_private_sb' + timer + '').css('display', 'none');
                }
            });

            $(".layer_btn").click(function () {
                $(".layer_btn").toggleClass('used_button');
                $(".layer_btn img").toggleAttrVal('src', './img/icon/btn_Layer.png', './img/icon/btn_Layer_c.png')
                $(".layer_d ").toggle();
                $(".square").hide();
                $(".edit").hide();
            });

            $(".color_btn").click(function () {
                $(".color_btn").toggleClass('used_button');
                $(".color_btn img").toggleAttrVal('src', './img/icon/btn_Color.png', './img/icon/btn_Color_c.png')
                $(".color_d ").toggle();
                $(".square").hide();
                $(".edit").hide();
            });

        });
        const ui = {
            confirm: async (message, secmess = null, yesbtn = "是", nobtn = "否") => createConfirm(message, secmess, yesbtn, nobtn),
            alert: async (message, secmess = null, yesbtn = "確定", nobtn = null) => createAlert(message, secmess, yesbtn, nobtn),
        }

        const createConfirm = (message, secmess, yesbtn, nobtn) => {
            return new Promise((complete, failed) => {

                $('#confirmNo').show();
                $('#secondMessage').html(secmess);
                $('#mainMessage').html(message);
                $('#confirmYes').text(yesbtn);
                $('#confirmNo').text(nobtn);

                $('#confirmYes').off('click');
                $('#confirmNo').off('click');

                $('#confirmYes').on('click', () => {
                    $('.confirm').hide();
                    complete(true);
                });
                $('#confirmNo').on('click', () => {
                    $('.confirm').hide();
                    complete(false);
                });

                $('.confirm').show();
            });
        }
        const createAlert = (message, secmess, yesbtn, nobtn) => {
            return new Promise((complete, failed) => {

                $('#secondMessage').text(secmess);
                $('#mainMessage').text(message);
                $('#confirmYes').text(yesbtn);
                $('#confirmNo').hide();

                $('#confirmYes').off('click');
                $('#confirmNo').off('click');

                $('#confirmYes').on('click', () => {
                    $('.confirm').hide();
                    complete(true);
                });
                $('#confirmNo').on('click', () => {
                    $('.confirm').hide();
                    complete(false);
                });

                $('.confirm').show();
            });
        }

        /** 
         * 刪除按鈕提醒 
         * */
        async function delete_alert() {
            if (await ui.confirm('是否確認刪除此類別?')) {
                return true
            }
            return false
        }
        async function delete_note_alert() { //David_20210526
            if (await ui.confirm('刪除此類別的所有標註?')) {
                return true
            }
            return false
        }
        async function delete_note_alert2() { //David_20210526
            if (await ui.confirm('刪除此標註?')) {
                return true
            }
            return false
        }
        /**
         * 刪除按鈕提醒
         * */
        async function warn_alert() {
            await ui.alert('請選擇顏色')
        }

        function pathReplace(path) {
            path = path.replace("/", "\\");
            return path
        }

        /** 
         * 發送返回清單請求 
         * */
        function toList() {
            window.parent.postMessage({
                cmd: 'returnList',
                params: {}
            }, '*');
        }

        /** 
         * 發送上傳至雲象的請求 
         * */
        function postAetherAI() {
            localStorage.setItem("caseJson", featureJSON)
            localStorage.setItem("caseJson_transform", featureJSON_transform);
            localStorage.setItem("textJSON", JSON.stringify(textJSON))
            localStorage.setItem("msgJSON", JSON.stringify(msgList));
            window.parent.postMessage({
                cmd: 'postAetherAIJSON',
                params: {}
            }, '*');
        }

        /** 
         * 手動存檔(忽略等待時間) 
         * */
        function sendCase() {
            localStorage.setItem("caseJson", featureJSON)
            localStorage.setItem("caseJson_transform", featureJSON_transform);
            localStorage.setItem("textJSON", JSON.stringify(textJSON))
            localStorage.setItem("msgJSON", JSON.stringify(msgList));
            window.parent.postMessage({
                cmd: 'returnCaseJSON',
            }, '*');
        }

        /** 
         * 自動存檔 
         * */
        function sendCase_imm() {
            localStorage.setItem("caseJson", featureJSON);
            localStorage.setItem("textJSON", JSON.stringify(textJSON));
            localStorage.setItem("msgJSON", JSON.stringify(msgList));
            if (workFlag) {
                window.parent.postMessage({
                    cmd: 'returnCaseJSON_imm',
                }, '*');
                workFlag = false;
                setTimeout(() => {
                    workFlag = true;
                }, 100);
            }
        }

        /**
         * 取得共用類別 
         */
        async function getCaseColorPublic() {
            const data = await axios.
                get(API_URL + "8088" + '/adminLabel', {
                    responseType: 'json',
                    headers: {
                        'x-access-token': token
                    }
                }).then((res) => res.data);
            return data
        }

        /**
        *取得個人設定類別
        */
        async function getCaseColorPrivate() {
            const data = await axios.
                get(API_URL + "8088" + '/userLabel', {
                    responseType: 'json',
                    headers: {
                        'x-access-token': token
                    }
                }).then((res) => res.data);
            return data
        }

        function setCaseColorPrivate(label, color) {
            return axios({
                method: 'post',
                url: API_URL + "8088" + '/userLabel',
                data: {
                    label: label,
                    color: color
                },
                headers: {
                    'x-access-token': token
                }
            })
        }

        function updateCaseColorPrivate(id, label) {
            return axios({
                method: 'put',
                url: API_URL + "8088" + '/userLabel/' + id,
                data: {
                    label: label
                },
                headers: {
                    'x-access-token': token
                }
            })
        }

        function deleteCaseColorPrivate(id) {
            return axios({
                method: 'delete',
                url: API_URL + "8088" + '/userLabel/' + id,
                headers: {
                    'x-access-token': token
                }
            })
        }

        //發生錯誤
        function errorReturn() {
            window.parent.postMessage({
                cmd: 'error',
                params: {}
            }, '*');
        }

        /**
         *  從陣列移除特定id */
        function removeId(id, list) {
            let index = this.idIndex(id, list);
            if (index != -1) {
                list.splice(index, 1);
                // console.log("removeId :", id, index, list);
            }
            // console.log(list);
        }

        /** 
         * 取得特定id在陣列的位置 */
        function idIndex(id, list) {
            let index = -1;
            id = parseInt(id)
            for (const key in list) {
                if (Object.hasOwnProperty.call(list, key)) {
                    const list_id = list[key]["id"];
                    if (id == list_id) {
                        index = key;
                        return index;
                    }
                }
            }
            return index;
        }

        //隨機亂數
        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        //移除選取狀態
        function removeSelectstatus() {
            let selectList = $('.layer_click_focus')
            let featureList = vectorLayer.getSource().getFeatures();

            console.log(selectList);

            for (let i = 0; i < selectList.length; i++) {
                const sltOBJ = selectList[i];
                const sltOBJindex = sltOBJ.firstChild.id;
                const sltOBJdiv = sltOBJ.parentNode;
                const sltOBJid = sltOBJdiv.firstChild.childNodes[0].id;
                const sltOBJcolor = sltOBJdiv.firstChild.childNodes[0].value;
                const feature = featureList[sltOBJindex]
                const featureID = feature.getId();
                const featureColor = feature.getProperties().hexCode;
                const featureStyle = new ol.style.Style({
                    stroke: new ol.style.Stroke({
                        color: featureColor,
                        width: 3
                    }),
                    fill: new ol.style.Fill({
                        color: 'rgba(255,255,255,0)',
                    }),
                });

                // console.log('slt :',sltOBJindex,sltOBJid,sltOBJcolor,'\n feature :',featureID,featureColor);
                if (sltOBJid == featureID) {
                    sltOBJ.classList.remove('layer_click_focus');
                    sltOBJdiv.childNodes[0].childNodes[1].value = 0;
                    feature.setStyle(featureStyle);
                }
            }
        }

        // hide color seletor
        async function refresh_color_seletor() {

            for (let i = 1; i <= 40; i++) {
                $('#color' + i).css('background', color_arr[i - 1]);
                $('#color' + i).attr('data-color', color_arr[i - 1]);
            }
            const publicClass = await getCaseColorPublic();
            const privateClass = await getCaseColorPrivate();
            for (let i = 0; i < publicClass.length; i++) {
                for (let j = 0; j < color_arr.length; j++) {
                    let color = publicClass[i].color;
                    if (color_arr[j] == color) {
                        $('#color' + (j + 1)).prop('disabled', true);
                        let preview = document.getElementById('color' + (j + 1));
                        preview.setAttribute("name", publicClass[i]._id);
                        // 標註畫筆初始為第一個共用類別
                        if (j == 0) {
                            initcolor = color_arr[j];
                        }
                    }
                }
            }
            for (let i = 0; i < privateClass.length; i++) {
                for (let j = 0; j < color_arr.length; j++) {
                    if (color_arr[j] == privateClass[i].color) {
                        $('#color' + (j + 1)).prop('disabled', true);
                        let preview = document.getElementById('color' + (j + 1));
                        preview.setAttribute("name", privateClass[i]._id);
                    }
                }
            }
        }


        async function refresh_color_list_public() {
            const publicClass = await getCaseColorPublic();

            for (let i = 1; i <= publicClass.length; i++) {
                let cont = $('#p' + i + '');
                let cont2 = $('#np' + i + ''); //David_20100525
                let cont3 = $('#npp' + i + ''); //David_20100527
                cont.html(i + '.&ensp;' + publicClass[i - 1].label);
                cont3.html(publicClass[i - 1].label); //David_20100527
                cont2.attr('id', publicClass[i - 1]._id); //David_20100525
                cont2.val(publicClass[i - 1].color); //David_20100525

                $('#color_public' + i + '').css('display', '');
                $('#note_public' + i + '').hide();
                $('#color_public' + i + ' .color_color div').css('background', publicClass[i - 1].color);
                $('#note_public' + i + ' .layer_color div').css('background', publicClass[i - 1].color); //David_20210521
                $('#color_public' + i + ' .color_color').attr({ 'data-color': publicClass[i - 1].color, 'data-colorlabel': publicClass[i - 1].label });
                $('#note_public' + i + ' .layer_color').attr({ 'data-color': publicClass[i - 1].color, 'data-colorlabel': publicClass[i - 1].label }); //David_20210521

                labelclass[publicClass[i - 1].label] = publicClass[i - 1].color
                if (publicClass[i - 1].color == '#000000')
                    tools.ColorMode(painterApp, publicClass[i - 1].color, publicClass[i - 1].label);
            }
            for (let i = publicClass.length + 1; i <= color_arr.length; i++) {
                $('#color_public' + i + '').css('display', 'none');
                $('#note_public' + i + '').css('display', 'none'); 
            }
        }

        async function refresh_color_list_private() {
            const privateClass = await getCaseColorPrivate();
            let i = ''

            privateIndex = privateClass.length

            for (i = 1; i <= privateClass.length; i++) {
                let cont = $('input[name=pp' + i + '');
                let cont2 = $('#nnp' + i + ''); //David_20100525
                let cont3 = $('#nnpp' + i + ''); //David_20100527
                cont.attr('value', privateClass[i - 1].label);
                cont.attr('id', privateClass[i - 1]._id);
                cont2.attr('id', privateClass[i - 1]._id); //David_20100525
                cont2.val(privateClass[i - 1].color); //David_20100525
                cont.attr('value', privateClass[i - 1].label);
                cont3.html(privateClass[i - 1].label); //David_20100527

                $('#color_private' + i).css('display', '');
                $('#note_private' + i).hide();
                $('#color_private' + i + ' .color_color div').css('background', privateClass[i - 1].color);
                $('#note_private' + i + ' .layer_color div').css('background', privateClass[i - 1].color); //David_20210521
                $('#color_private' + i + ' .color_color').attr({ 'data-color': privateClass[i - 1].color, 'data-colorlabel': privateClass[i - 1].label });
                $('#note_private' + i + ' .layer_color').attr({ 'data-color': privateClass[i - 1].color, 'data-colorlabel': privateClass[i - 1].label }); //David_20210521
                $('#note_private' + i + ' .t4').show()

                labelclass[privateClass[i - 1].label] = privateClass[i - 1].color
            }

            let cont_other = $('input[name=pp' + i + '');
            let cont_other2 = $('#nnp' + i + ''); //David_20100525
            let cont_other3 = $('#nnpp' + i + ''); //David_20100527
            cont_other.attr('value', 'Other');
            cont_other.attr('id', '');
            cont_other2.attr('id', ''); //David_20100525
            cont_other2.val('transparent'); //David_20100525
            cont_other.attr('value', 'Others');
            cont_other3.html('Others'); //David_20100527

            $('#color_private' + i).css('display', '');
            $('#note_private' + i).hide();
            $('#color_private' + i + ' .color_color div').css('background', 'transparent');
            $('#note_private' + i + ' .layer_color div').css('background', 'transparent'); //David_20210521
            $('#color_private' + i + ' .color_color').attr({ 'data-color': 'transparent', 'data-colorlabel': 'Others' });
            $('#note_private' + i + ' .layer_color').attr({ 'data-color': 'transparent', 'data-colorlabel': 'Others' }); //David_20210521
            $('#note_private' + i + ' .t4').hide()

            for (let j = privateClass.length + 1; j <= color_arr.length; j++) {
                $('#color_private' + j).css('display', 'none');
                $('#note_private' + j).css('display', 'none');
                $('#note_private_sp' + j).css('display', 'none');
                $('#note_private_sb' + j).css('display', 'none');
            }
        }

        /**
         * 初始化標註管理清單
        */
        function initializationFeatureslist() {
            let parentHTMLel = $('#layer_table');
            let publicHTML = ''
            let privateHTML = ''
            let textHTML = ''

            let privateTitle = document.createElement('div');
            let privateTitleinn = document.createElement('div');
            let textTitle = document.createElement('div');
            let textTitleinn = document.createElement('div');

            privateTitleinn.innerHTML = 'Private:';
            textTitleinn.innerHTML = 'Text:';

            //產生共用類別
            for (let i = 1; i < 41; i++) {
                publicHTML = '<!-- public' + i + ' -->' +
                    '<div class="table_tr note_public" id="note_public' + i + '">' +
                    '<div class="t1" style="width: 16%;">' +
                    '<img src="./img/icon/layer_see.png" alt="" id="image_public_' + i + '" class="img-fluid" data-type="public"' +
                    'data-used="0" data-cansee="1">' +
                    '<input id="np' + i + '" type="hidden" class=""></div>' +
                    '<div class="t2" id="note_public_t2_' + i + '" style="width: 46%;">' +
                    '<button class="tran_btn layer_color" disabled>' +
                    '<div style="border-radius:50%; background-color: greenyellow"></div>' +
                    '</button>' +
                    '<span id="npp' + i + '">圖層</span></div>' +
                    '<div class="t3" id="note_public_t3_' + i + '" style="width: 30%;">' +
                    '<span id="n' + i + '"></span></div>' +
                    '<div class="t4" style="width: 8%;">' +
                    '<button type="button" class="tran_btn p-0 pr-1">' +
                    '<i class="far fa-trash-alt"></i>' +
                    '</button></div></div>' +
                    '<div class="table_tr note_public_sp" id="note_public_sp' + i + '" style="display: none;">' +
                    '<div style="width: 16%;"> </div>' +
                    '<div class="table_tr no_hover" style="width: 84%;">' +
                    '<div style="height: 1px;width:100%;background: #4767A0;margin:5px 0rem 5px 0rem;padding: 0;border: none">' +
                    '</div></div></div>' +
                    '<div class="table_tr note_public_sb" id="note_public_sb' + i + '" style="display: none;"></div>'

                parentHTMLel.append(publicHTML)
            }

            privateTitle.append(privateTitleinn)
            parentHTMLel.append(privateTitle);

            //產生個人類別
            for (let i = 1; i < 41; i++) {
                privateHTML = '<!--private' + i + ' -->' +
                    '<div class="table_tr note_private" id="note_private' + i + '">' +
                    '<div class="t1" style="width: 16%;">' +
                    '<img src="./img/icon/layer_see.png" alt="" id="image_private_' + i + '" class="img-fluid" data-type="private"' +
                    'data-used="0" data-cansee="1">' +
                    '<input id="nnp' + i + '" type="hidden" class=""></div>' +
                    '<div class="t2" id="note_private_t2_' + i + '" style="width: 46%;">' +
                    '<button type="button" class="tran_btn layer_color edit_color" disabled>' +
                    '<div style="border-radius:50%; background-color: greenyellow"></div>' +
                    '</button>' +
                    '<span id="nnpp' + i + '">圖層</span></div>' +
                    '<div class="t3" id="note_private_t3_' + i + '" style="width: 30%;">' +
                    '<span id="nn' + i + '"></span></div>' +
                    '<div class="t4" style="width: 8%;">' +
                    '<button type="button" class="tran_btn p-0 pr-1">' +
                    '<i class="far fa-trash-alt"></i>' +
                    '</button></div></div>' +
                    '<div class="table_tr note_private_sp" id="note_private_sp' + i + '" style="display: none;">' +
                    '<div style="width: 16%;"> </div>' +
                    '<div class="table_tr no_hover" style="width: 84%;">' +
                    '<div style="height: 1px;width:100%;background: #4767A0;margin:5px 0rem 5px 0rem;padding: 0;border: none">' +
                    '</div></div></div>' +
                    '<div class="table_tr note_private_sb" id="note_private_sb' + i + '" style="display: none;"></div>'

                parentHTMLel.append(privateHTML);
            }

            //產生文字
            textTitle.append(textTitleinn)
            parentHTMLel.append(textTitle);

            textHTML = '<!-- text -->' +
                '<div class="table_tr note_private" id="note_private_text">' +
                '<div class="t1" style="width: 16%;">' +
                '<img src="./img/icon/layer_see.png" alt="" id="n_text"' +
                'class="img-fluid" data-type="private" data-used="0"' +
                'data-cansee="1">' +
                '<input id="nnp_text" type="hidden" class=""></div>' +
                '<div class="t2" id="note_private_t2__text" style="width: 46%;">' +
                '<button class="tran_btn layer_color  edit_color" type="button" disabled>' +
                '<div style="border-radius:50%; background-color: greenyellow"></div></button>' +
                '<span id="nnpp_text">圖層</span></div>' +
                '<div class="t3" id="note_private_t3__text" style="width: 30%;">' +
                '<span id="nn_text"></span></div>' +
                '<div class="t4" style="width: 8%;">' +
                '<button type="button" class="tran_btn p-0 pr-1">' +
                '<i class="far fa-trash-alt"></i></button></div></div>' +
                '<div class="table_tr note_private_sp" id="note_private_sp_text"' +
                'style="display: none;">' +
                '<div style="width: 16%;"> </div>' +
                '<div class="table_tr no_hover" style="width: 84%;">' +
                '<div style="height: 1px;width:100%;background: #4767A0;margin:5px 0rem 5px 0rem;padding: 0;border: none">' +
                '</div></div></div>' +
                '<div class="table_tr note_private_sb" id="note_private_sb_text"' +
                'style="display: none;"></div>'

            parentHTMLel.append(textHTML);
        }

        async function refresh_Feature_list() { //David_20210521 
            // console.log("refresh_Feature_list start");
            const selectedFile = _currentIsyntaxImageLocation.concat('\\', _currentIsyntaxImageName);
            const updatedFile = sessionStorage.getItem(selectedFile + '-updated');
            const originalFile = sessionStorage.getItem(selectedFile + '-original');

            const publicClass = await getCaseColorPublic();
            const privateClass = await getCaseColorPrivate();

            // console.log(publicClass, privateClass);

            layerJSON = updatedFile && updatedFile != undefined ? updatedFile : originalFile

            if (layerJSON == 'null') {
                layerJSON = new Array(0)
            }

            if (layerJSON.length != 0) {
                layerJSON = JSON.parse(layerJSON)["features"];
                {
                    let i = 0;
                    let j = 0;

                    if (msgList == null) {
                        msgList = JSON.parse(localStorage.getItem("msgJSON"));
                    }

                    $(".img-fluid[data-type='public']").attr("data-used", "0");

                    if (layerJSON != "null" && layerJSON != null) {

                        for (i = 0; i < publicClass.length; i++) {
                            let htmlStr = "";
                            let color = publicClass[i].color;
                            let k = 0;

                            for (j = 0; j < layerJSON.length; j++) {
                                let id_2 = layerJSON[j]["id"];
                                let color_2 = layerJSON[j]["properties"]["hexCode"];
                                let value_2 = "";
                                const msgIndex = idIndex(id_2, msgList)
                                let MSG = "";
                                let msg_ID = "";

                                if (msgIndex != -1) {
                                    MSG = msgList[msgIndex]["message"] != undefined ? msgList[msgIndex]["message"] : "";
                                    msg_ID = msgList[msgIndex]["_id"] != undefined ? msgList[msgIndex]["_id"] : "";
                                }

                                if ($("#" + id_2 + "_1").length > 0) {
                                    value_2 = "" + document.getElementById(id_2 + "_1").value;

                                    if (value_2 == "")
                                        value_2 = "0";
                                } else
                                    value_2 = "0";

                                if (color == color_2) {
                                    k = k + 1;
                                    removeIDlist.push(id_2)

                                    htmlStr += '<div class="table_tr_d note_public" id="note_public_sub' + k + '" style="width: 100%;">' +
                                        '<div class="t1" style="width: 15%;">' +
                                        '<input id="' + id_2 + '" type="hidden" class="" value="' + color_2 + '">' +
                                        '<input id="' + id_2 + '_1" type="hidden" class="" value="' + value_2 + '">' +
                                        '</div>';
                                    if (value_2 == "0")
                                        htmlStr += '<div class="t2" style="width: 25%;">';
                                    else
                                        htmlStr += '<div class="t2 layer_click_focus" style="width: 25%;">';
                                    htmlStr +=
                                        '<span id="' + j + '">標註' + k + '</span>' +
                                        '</div>' +
                                        '<div class="layer_d_click" style="width: 60%;">' +
                                        '<div class="t3" style="width: 75%;">' +
                                        '<input id="' + id_2 + '" class="featureMSG" data-id = "' + msg_ID + '" value="' + MSG + '" readonly type="text"/>' +
                                        '</div>' +
                                        '<div class="t4" style="width: 25%;">' +
                                        '<button class="tran_btn layer_color change_color" data-color="' +
                                        color_2 + '" data-id = "' + id_2 + '">' +
                                        '<i class="fas fa-exchange-alt"></i></button>' +
                                        '<button type="button" class="tran_btn p-0 pr-1">' +
                                        '<i class="far fa-trash-alt"></i>' +
                                        '</button>' +
                                        '</div></div></div>';
                                }
                            }
                            if (htmlStr != "")
                                htmlStr = '<div style="width: 100%; display: block;">' + htmlStr + '</div>';

                            let cont = $('#n' + (i + 1) + '');
                            let cont_2 = $('#note_public_sb' + (i + 1) + '');


                            if (k > 0) {
                                cont.html("數量：" + k);

                                $('#note_public' + (i + 1) + ' .t1 .img-fluid').attr('data-used', '1');

                                $('#note_public' + (i + 1)).show();
                            } else {
                                cont.html("");
                                $('#note_public' + (i + 1)).hide();
                            }
                            cont_2.html(htmlStr);
                            if (htmlStr == "") {
                                $('#note_public_sp' + (i + 1) + '').css('display', 'none');
                                $('#note_public_sb' + (i + 1) + '').css('display', 'none');
                            }
                        }
                    }
                }

                {
                    let i = 0;
                    let j = 0;

                    $(".img-fluid[data-type='private']").attr("data-used", "0");

                    if (layerJSON != "null" && layerJSON != null) {
                        for (i = 0; i < privateClass.length; i++) {
                            let htmlStr = "";
                            let color = privateClass[i].color;
                            let k = 0;

                            for (j = 0; j < layerJSON.length; j++) {
                                let id_2 = layerJSON[j]["id"];
                                let color_2 = layerJSON[j]["properties"]["hexCode"];
                                let value_2 = "";
                                const msgIndex = idIndex(id_2, msgList)
                                let MSG = "";
                                let msg_ID = "";

                                if (msgIndex != -1) {
                                    MSG = msgList[msgIndex]["message"] != undefined ? msgList[msgIndex]["message"] : "";
                                    msg_ID = msgList[msgIndex]["_id"] != undefined ? msgList[msgIndex]["_id"] : "";
                                }

                                if ($("#" + id_2 + "_1").length > 0) {
                                    value_2 = "" + document.getElementById(id_2 + "_1").value;

                                    if (value_2 == "")
                                        value_2 = "0";
                                } else
                                    value_2 = "0";

                                if (color == color_2) {
                                    k = k + 1;
                                    removeIDlist.push(id_2)

                                    htmlStr += '<div class="table_tr_d note_private" id="note_private_sub' + k + '" style="width: 100%;">' +
                                        '<div class="t1" style="width: 15%;">' +
                                        '<input id="' + id_2 + '" type="hidden" class="" value="' + color_2 + '">' +
                                        '<input id="' + id_2 + '_1" type="hidden" class="" value="' + value_2 + '">' +
                                        '</div>';
                                    if (value_2 == "0")
                                        htmlStr += '<div class="t2" style="width: 25%;">';
                                    else
                                        htmlStr += '<div class="t2 layer_click_focus" style="width: 25%;">';
                                    htmlStr += '<span id="' + j + '">標註' + k + '</span>' +
                                        '</div>' +
                                        '<div class="layer_d_click" style="width: 60%;">' +
                                        '<div class="t3" style="width: 75%;">' +
                                        '<input id="' + id_2 + '" class="featureMSG" data-id = "' + msg_ID + '" value="' + MSG + '" readonly type="text"/>' +
                                        '</div>' +
                                        '<div class="t4" style="width: 25%;">' +
                                        '<button class="tran_btn layer_color change_color" data-color="' +
                                        color_2 + '" data-id = "' + id_2 + '">' +
                                        '<i class="fas fa-exchange-alt"></i></button>' +
                                        '<button type="button" class="tran_btn p-0 pr-1">' +
                                        '<i class="far fa-trash-alt"></i>' +
                                        '</button>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>';
                                }
                            }
                            if (htmlStr != "")
                                htmlStr = '<div style="width: 100%; display: block;">' + htmlStr + '</div>';

                            let cont = $('#nn' + (i + 1) + '');
                            let cont_2 = $('#note_private_sb' + (i + 1) + '');


                            if (k > 0) {
                                cont.html("數量：" + k);
                                $('#note_private' + (i + 1) + ' .t1 .img-fluid').attr('data-used', '1');
                                $('#note_private' + (i + 1)).show();
                            } else {
                                cont.html("");
                                $('#note_private' + (i + 1)).hide();
                            }
                            cont_2.html(htmlStr);

                            if (htmlStr == "") {
                                $('#note_private_sp' + (i + 1) + '').css('display', 'none');
                                $('#note_private_sb' + (i + 1) + '').css('display', 'none');
                            }
                        }
                    }
                };
            }
        }

        /** 處理無類別標註 */
        async function refresh_Feature_list_Other() {
            // console.log("refresh_Feature_list_Other start");
            let flag = true
            for (let index = 0; index < removeIDlist.length; index++) {
                removeId(removeIDlist[index], layerJSON)
            }
            removeIDlist = []
            if (layerJSON.length != 0) {
                let htmlStr = "";
                let k = 0;

                for (j = 0; j < layerJSON.length; j++) {
                    let id_2 = layerJSON[j]["id"];
                    let color_2 = layerJSON[j]["properties"]["hexCode"];
                    let value_2 = "";
                    const msgIndex = idIndex(id_2, msgList)
                    let MSG = "";
                    let msg_ID = "";

                    if (msgIndex != -1) {
                        MSG = msgList[msgIndex]["message"] != undefined ? msgList[msgIndex]["message"] : "";
                        msg_ID = msgList[msgIndex]["_id"] != undefined ? msgList[msgIndex]["_id"] : "";
                    }

                    if ($("#" + id_2 + "_1").length > 0) {
                        value_2 = "" + document.getElementById(id_2 + "_1").value;

                        if (value_2 == "")
                            value_2 = "0";
                    } else
                        value_2 = "0";

                    k = k + 1;

                    htmlStr += '<div class="table_tr_d note_private" id="note_private_sub' + k + '" style="width: 100%;">' +
                        '<div class="t1" style="width: 15%;">' +
                        '<input id="' + id_2 + '" type="hidden" class="" value="' + color_2 + '">' +
                        '<input id="' + id_2 + '_1" type="hidden" class="" value="' + value_2 + '">' +
                        '</div>';
                    if (value_2 == "0")
                        htmlStr += '<div class="t2" style="width: 25%;">';
                    else
                        htmlStr += '<div class="t2 layer_click_focus" style="width: 25%;">';
                    htmlStr += '<span id="' + j + '">標註' + k + '</span>' +
                        '</div>' +
                        '<div class="layer_d_click" style="width: 60%;">' +
                        '<div class="t3" style="width: 75%;">' +
                        '<input id="' + id_2 + '" class="featureMSG" data-id = "' + msg_ID + '" value="' + MSG + '" readonly type="text"/>' +
                        '</div>' +
                        '<div class="t4" style="width: 25%;">' +
                        '<button class="tran_btn layer_color change_color" data-color="' +
                        color_2 + '" data-id = "' + id_2 + '">' +
                        '<i class="fas fa-exchange-alt"></i></button>' +
                        '<button type="button" class="tran_btn p-0 pr-1">' +
                        '<i class="far fa-trash-alt"></i>' +
                        '</button>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                }
                if (htmlStr != "")
                    htmlStr = '<div style="width: 100%; display: block;">' + htmlStr + '</div>';

                let cont = $('#nn' + (privateIndex + 1) + '');
                let cont_2 = $('#note_private_sb' + (privateIndex + 1) + '');

                if (k > 0) {
                    cont.html("數量：" + k);
                    $('#note_private' + (privateIndex + 1) + ' .t1 .img-fluid').attr('data-used', '1');
                    $('#note_private' + (privateIndex + 1)).show();
                } else {
                    cont.html("");
                    $('#note_private' + (privateIndex + 1)).hide();
                }
                cont_2.html(htmlStr);
            } else {
                $('#note_private_sp' + (privateIndex + 1) + '').css('display', 'none');
                $('#note_private_sb' + (privateIndex + 1) + '').css('display', 'none');
            }
        }

        /**
         * 修改標註顏色
        */
        async function changeFeaturecolor(id, color) {
            let featureList = vectorLayer.getSource().getFeatures();
            let newStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: color,
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255,255,255,0)',
                }),
            });

            removeSelectstatus()

            for (let l = 0; l < featureList.length; l++) {
                const feature = featureList[l];
                const feature_id = feature.getId();

                if (id == feature_id) {
                    // console.log("changeFeaturecolor");
                    feature.setProperties({
                        hexCode: color,
                    });
                    feature.setStyle(newStyle);
                    sendCase_imm();
                    break;
                }
            }
        }

        // 繪圖類別
        class PainterApp {
            constructor(elementId, image, width, height) {
                this.height = height;
                this.width = width;
                this.stage = new Konva.Stage({
                    container: elementId,
                    width: width,
                    height: height
                });
                this.layer = new Konva.Layer();
                this.background = new Konva.Image({
                    x: 0,
                    y: 0,
                    image: image,
                    width: width,
                    height: height
                });
                this.layer.add(this.background);
                this.stage.add(this.layer);
                this.container = this.stage.container();
                this.lockDraggable = false;
                this.onModeChangeCallback = [];
                let context = this;
                this.currentMode = '';
                $('#wait_img_load').hide();
            }

            destroyOldPlaceholder() {
                if (this.placeholder)
                    this.placeholder.destroy();
                this.placeholder = null;
            }

            setColor(Color, label) {
                onColorChange(Color);
                // console.log('setColor : ', strokeColor)
            }

            onModeChange(mode) {
                while (this.onModeChangeCallback.length > 0)
                    this.onModeChangeCallback.pop()();
                this.lockDraggable = false;
                tools[mode](this);
                this.currentMode = mode;
            }
        }

        // APP 初始化副程式
        async function initPainterApp(parent) {
            const urlValue = pathReplace(filePath);
            measureIndex = localStorage.getItem("id") != null ? JSON.parse(localStorage.getItem("id")) : 0;

            refresh_color_seletor();

            // console.log("measureIndex : ", measureIndex, "initcolor ", initcolor);

            painterApp = new PainterApp('painter_panel', renderViewer(urlValue), this.width, this.height);
            msgList = JSON.parse(localStorage.getItem('msgJSON'))

            addEscListener();
            initializationFeatureslist();
            refresh_color_list_public();
            refresh_color_list_private();

            $(document).ready(function () {

                // jquery toggle just the attribute value
                $.fn.toggleAttrVal = function (attr, val1, val2) {
                    let test = $(this).attr(attr);
                    if (test === val1) {
                        $(this).attr(attr, val2);
                        return this;
                    }
                    if (test === val2) {
                        $(this).attr(attr, val1);
                        return this;
                    }
                    // default to val1 if neither
                    $(this).attr(attr, val1);
                    return this;
                };
                $(document).off('click', "#layer_table .table_tr .layer_hover .t3 ,.table_tr .layer_hover .t4")
                    .on('click', "#layer_table .table_tr .layer_hover .t3 ,.table_tr .layer_hover .t4", function () {

                        $(this).parent().parent().find(".table_tr_tr").toggle();
                        $(this).parent().parent().next(".table_tr_tr").toggle();
                        $(this).parent().parent().children(".layer_hover").toggleClass("layer_click")

                    });

                //刪除按鈕提醒
                $(document).on("click", '.eraselayer', async function () {
                    if (await ui.confirm('確定刪除?')) {
                        let id = '.' + $(this).attr('data-konvaid');
                        $(this).closest('[data-konvaid="' + id + '"]')
                        //刪除此項
                        let willdisapear = $(this).closest('.table_tr_d');
                        willdisapear.remove();
                        let testdelete = painterApp.stage['children'][0]['children'];
                        //該id的json物件
                        let getIDattr = JSON.parse(painterApp.stage.find(id)[0].toJSON());

                        //更動該顏色數量 console.log(getIDattr['attrs']['stroke']);
                        let willminus = $('[data-konvastroke="' + getIDattr['attrs']['stroke'] + '"]').find('.t4 span');
                        willminus.html(willminus.text() - 1)
                        // console.log(willminus.html());
                        //該ID的index
                        // console.log(painterApp.stage.find(id)[0]['index']);
                        let index_num = testdelete.findIndex(function (item) {
                            return item.index == painterApp.stage.find(id)[0]['index'];
                        });

                        //刪除該圖案並存檔
                        testdelete.splice([index_num], 1);
                        sendCase_imm();
                        //馬上更改畫面
                        let layer = painterApp.layer;
                        layer.batchDraw();
                        // console.log(testdelete);

                    }

                });

                //圖層--眼睛圖案控制、展開收合
                $(document).off('click', "#layer_table .table_tr .t1 img, .table_tr_tr .t1 img")
                    .on('click', "#layer_table .table_tr .t1 img, .table_tr_tr .t1 img", function () {
                        let data_cansee = $(this).attr('data-cansee')
                        //確認按的是不是大項目
                        let istable_tr = $(this).closest('.table_tr').get(0);
                        //大項目關閉所有該顏色隱藏
                        if (istable_tr != undefined) {
                            let note_id = $(this).parent().find('input')[0].id;
                            let note_color = $(this).parent().find('input')[0].value;
                            let feature_hilight = "";
                            let highlightStyle = new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: note_color,
                                    width: 5
                                }),
                                fill: new ol.style.Fill({
                                    color: 'rgba(155,178,249,0.7)',
                                }),
                            });
                            let highlightStyle2 = new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: note_color,
                                    width: 3
                                }),
                                fill: new ol.style.Fill({
                                    color: 'rgba(255,255,255,0)',
                                }),
                            });

                            if (note_id == 'text_0') {
                                if (data_cansee == 0) {
                                    note_list_text_eye_ctrl('open');
                                }
                                else {
                                    note_list_text_eye_ctrl('close');
                                }
                            } else {
                                let feature = vectorLayer.getSource().getFeatures();
                                let i = 0;

                                for (i = 0; i < feature.length; i++) {
                                    let feature_d = feature[i];
                                    let feature_id = feature_d.getId();
                                    let feature_color = feature_d.getProperties().hexCode;

                                    if ($("#" + feature_id + "_1").length > 0) {
                                        feature_hilight = "" + document.getElementById(feature_id + "_1").value;

                                        if (feature_hilight == "")
                                            feature_hilight = "0";
                                    } else
                                        feature_hilight = "0";

                                    if (note_color == feature_color) {
                                        if (data_cansee == 0) {
                                            if (feature_hilight == "0")
                                                feature[i].setStyle(highlightStyle2);
                                            else
                                                feature[i].setStyle(highlightStyle);
                                        } else {
                                            feature[i].setStyle(new ol.style.Style({}));
                                        }
                                    }
                                }
                            }
                        }
                        //只要一按眼睛顯示全部就會取消勾選
                        $(this).toggleAttrVal('src', './img/icon/layer_see_d.png', './img/icon/layer_see.png')
                        $(this).toggleAttrVal('data-cansee', '0', '1')
                        if (($(".img-fluid[data-type='public'][data-used='1'][data-cansee='0']").length +
                            $(".img-fluid[data-type='private'][data-used='1'][data-cansee='0']").length) == 0)
                            $('#show_all_layer').prop('checked', true);
                        else
                            $('#show_all_layer').prop('checked', false);
                        data_cansee = $(this).attr('data-cansee')
                        if (data_cansee == 0) {
                            $(this).parent().parent().parent().next(".table_tr_tr").find(".t1 img").attr('data-cansee', '0')
                            $(this).parent().parent().parent().next(".table_tr_tr").find(".t1 img").attr('src', './img/icon/layer_see_d.png')
                        }
                    })

                if ($('#show_all_layer').is(":checked")) {
                    $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').attr('src', './img/icon/layer_see.png')
                    $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').data('cansee', '1')
                }

                //點選後反白與底色變化
                $(document).on('click', '#layer_table .note_public_sb .note_public .t2', function () {
                    if (document.getElementById('show_all_layer').checked) {
                        let note_id = $(this).prev().find('input')[0].id;
                        let note_id2 = $(this).parent().parent().parent().prev().prev().find('div')[1].id; //David_20210529
                        let note_id3 = "image_public_" + note_id2.replace("note_public_t2_", ""); //David_20210529
                        let note_color = $(this).prev().find('input')[0].value;
                        let note_hilight = $(this).prev().find('input')[1].value;
                        let note_cansee = $('#' + note_id3).attr('data-cansee'); //David_20210529
                        let feature = vectorLayer.getSource().getFeatures();
                        const highlightStyle = new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: note_color,
                                width: 5
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(155,178,249,0.7)',
                            }),
                        });
                        let highlightStyle2

                        removeSelectstatus()

                        for (let l = 0; l < feature.length; l++) {
                            let feature_d = feature[l];
                            let feature_id = feature_d.getId();
                            let feature_color = feature_d.getProperties().hexCode;
                            highlightStyle2 = new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: feature_color,
                                    width: 3
                                }),
                                fill: new ol.style.Fill({
                                    color: 'rgba(255,255,255,0)',
                                }),
                            });

                            if ((note_id == feature_id) && (note_color == feature_color)) {
                                if (note_hilight == "0") {
                                    $(this).prev().find('input')[1].value = "1";

                                    $(this).addClass('layer_click_focus');

                                    if (note_cansee == "1") //David_20210529
                                        feature[l].setStyle(highlightStyle);
                                } else {
                                    $(this).prev().find('input')[1].value = "0";

                                    $(this).removeClass('layer_click_focus');

                                    if (note_cansee == "1") //David_20210529
                                        feature[l].setStyle(highlightStyle2);
                                }
                                break;
                            }
                        }
                    }
                });

                $(document).on('click', '#layer_table .note_public_sb .note_public .t4 .tran_btn.p-0.pr-1', async function () {
                    if (await delete_note_alert2()) {
                        let note_id = $(this).parent().parent().prev().prev().find('input')[0].id; //David_20210602
                        let note_color = $(this).parent().parent().prev().prev().find('input')[0].value; //David_20210602
                        const feature = vectorLayer.getSource().getFeatures();
                        let l = 0;

                        for (l = 0; l < feature.length; l++) {
                            let feature_d = feature[l];
                            let feature_id = feature_d.getId();
                            let feature_color = feature_d.getProperties().hexCode;

                            if ((note_id == feature_id) && (note_color == feature_color)) {
                                vectorSource.removeFeature(feature[l]);

                                _delete = new ol.interaction.Select({
                                    features: feature_d,
                                });

                                map.removeInteraction(_delete);
                            }
                        }

                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list();
                        refresh_Feature_list_Other();
                        sendCase_imm();
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526
                    }

                })

                $(document).on('click', '#layer_table .note_private_sb .note_private .t2', function () {
                    let note_id = $(this).prev().find('input')[0].id;
                    let note_id2 = $(this).parent().parent().parent().prev().prev().find('div')[1].id; //David_20210529
                    let note_id3 = "image_private_" + note_id2.replace("note_private_t2_", ""); //David_20210529
                    let note_color = $(this).prev().find('input')[0].value;
                    let note_hilight = $(this).prev().find('input')[1].value;
                    let note_cansee = $('#' + note_id3).attr('data-cansee'); //David_20210529
                    let feature = vectorLayer.getSource().getFeatures();
                    let l = 0;
                    let highlightStyle = new ol.style.Style({
                        stroke: new ol.style.Stroke({
                            color: note_color,
                            width: 5
                        }),
                        fill: new ol.style.Fill({
                            color: 'rgba(155,178,249,0.7)',
                        }),
                    });
                    let highlightStyle2;

                    removeSelectstatus()

                    for (l = 0; l < feature.length; l++) {
                        let feature_d = feature[l];
                        let feature_id = feature_d.getId();
                        let feature_color = feature_d.getProperties().hexCode;
                        highlightStyle2 = new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: feature_color,
                                width: 3
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(255,255,255,0)',
                            }),
                        });

                        if ((note_id == feature_id) && (note_color == feature_color)) {
                            if (note_hilight == "0") {
                                $(this).prev().find('input')[1].value = "1";

                                $(this).addClass('layer_click_focus');

                                if (note_cansee == "1") //David_20210529
                                    feature[l].setStyle(highlightStyle);
                            } else {
                                $(this).prev().find('input')[1].value = "0";

                                $(this).removeClass('layer_click_focus');

                                if (note_cansee == "1") //David_20210529
                                    feature[l].setStyle(highlightStyle2);
                            }

                            break;
                        }
                    }
                });

                $(document).on('click', '#layer_table .note_private_sb .note_private .t4 .tran_btn.p-0.pr-1', async function () {
                    let check = await delete_note_alert2()
                    if (check) {//David_20210526_刪除按鈕提醒
                        let note_id = $(this).parent().parent().prev().prev().find('input')[0].id; //David_20210602
                        let note_color = $(this).parent().parent().prev().prev().find('input')[0].value; //David_20210602
                        const feature = vectorLayer.getSource().getFeatures();
                        let l = 0;

                        for (l = 0; l < feature.length; l++) {
                            let feature_d = feature[l];
                            let feature_id = feature_d.getId();
                            let feature_color = feature_d.getProperties().hexCode;

                            if ((note_id == feature_id) && (note_color == feature_color)) {
                                vectorSource.removeFeature(feature[l]);
                                _delete = new ol.interaction.Select({
                                    features: feature_d,
                                });

                                map.removeInteraction(_delete);
                            }
                        }

                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list()
                        // refresh_Feature_list_Other();
                        sendCase_imm();
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526
                    }

                })

                //顯示全部轉換為打勾時全顯示
                $('#show_all_layer').change(function (event) {
                    let layer = painterApp.layer;
                    let checkbox = event.target;
                    $('#show_all_layer').blur()
                    if (checkbox.checked) {
                        $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').attr('src', './img/icon/layer_see.png')
                        $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').attr('data-cansee', '1')

                        note_list_text_eye_ctrl('open');
                        vectorLayer.setVisible(true);

                        let feature = vectorLayer.getSource().getFeatures();

                        for (let i = 0; i < feature.length; i++) {
                            let feature_d = feature[i];
                            let feature_id = feature_d.getId();
                            let feature_color = feature_d.getProperties().hexCode;
                            let feature_hilight = "";
                            let highlightStyle = new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: feature_color,
                                    width: 5
                                }),
                                fill: new ol.style.Fill({
                                    color: 'rgba(174,214,241,0.7)',
                                }),
                            });
                            let unlightStyle = new ol.style.Style({
                                stroke: new ol.style.Stroke({
                                    color: feature_color,
                                    width: 3
                                }),
                                fill: new ol.style.Fill({
                                    color: 'rgba(255,255,255,0)',
                                }),
                            });

                            // console.log($("#" + feature_id + "_1"));
                            if ($("#" + feature_id + "_1").length > 0) {
                                feature_hilight = "" + document.getElementById(feature_id + "_1").value;

                                if (feature_hilight == "")
                                    feature_hilight = "0";
                            } else
                                feature_hilight = "0";

                            if (feature_hilight == "0")
                                feature[i].setStyle(unlightStyle);
                            else
                                feature[i].setStyle(highlightStyle);

                            // feature[i].set("hidden", false);
                        }
                    } else { //David_20210526
                        $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').attr('src', './img/icon/layer_see_d.png');
                        $('#layer_table .table_tr .t1 img, .table_tr_tr .t1 img').attr('data-cansee', '0');
                        note_list_text_eye_ctrl('close');
                        vectorLayer.setVisible(false);
                    }
                });

                //將標註註解框狀態修改為可編輯
                $(document).on('dblclick', '.featureMSG', function () {
                    $(this).removeAttr('readonly')
                })

                //儲存標註註解
                $(document).on('blur change', '.featureMSG', async function () {
                    console.log("MSG change start");
                    let msgID = $(this).attr('id')
                    let msg_ID = $(this).data('id')

                    msgList = JSON.parse(localStorage.getItem("msgJSON"));

                    if (event.type == 'change') {
                        console.log($(this).val());

                        if (idIndex(msgID, msgList) !== -1) {
                            msg_ID = msgList[idIndex(msgID, msgList)]['_id']
                            removeId(msgID, msgList);
                            console.log(msgID, msg_ID, msgList);
                        }


                        msgList.push({
                            _id: msg_ID,
                            id: JSON.parse(msgID),
                            message: $(this).val(),
                        })
                        $(this).attr('readonly', true)

                        sendCase_imm();
                    }
                    else if (event.type == 'blur') {
                        $(this).attr('readonly', true)
                    }
                })

                //載入可更動樣式
                $(document).off('click', '.change_color').on('click', '.change_color', function () {
                    //之前未選擇的則消失
                    if ($('#changeColor').length) {
                        $('#changeColor').remove()
                    }
                    oldColor = $(this).data('color');
                    selectID = $(this).data('id');
                    let selecthtml = ' <select name="" id="changeColor">';
                    for (let key in labelclass) {
                        if (labelclass[key] == oldColor) {
                            selecthtml += '<option value="' + labelclass[key] + '" data-class = "' + key + '" style="background:' + labelclass[key] + '" selected>' + key + '</option >'
                        } else {
                            selecthtml += '<option value="' + labelclass[key] + '" data-class = "' + key + '" style="background:' + labelclass[key] + '">' + key + '</option >'
                        }
                    }
                    selecthtml += '</select>'

                    $(this).parent().append(selecthtml)
                    $('#changeColor').focus()
                })

                //已選更換類別後
                $(document).on('blur change', '#changeColor', async function () {
                    if (event.type == 'change') {
                        let newClass = $('#changeColor :selected').data('class');
                        let newColor = $('#changeColor :selected').val();

                        // console.log("change_color ", oldColor, selectID, newClass);

                        if (oldColor != newColor) {
                            if (await ui.confirm('確定要將此項標註的類別更動為：' + newClass)) {
                                changeFeaturecolor(selectID, newColor)
                            }
                        }
                        $('#changeColor').hide()
                    }
                    else if (event.type == 'blur') {
                        if ($('#changeColor').length) {
                            $('#changeColor').remove()
                        }
                    }
                })

                //按下修改才能更動private部分(類別顏色)
                $('.color_private .t4').unbind("click").bind("click", async function () {
                    //刪除按鈕提醒
                    // let check = delete_alert();
                    //alert('確定刪除?')
                    // 刪除個人類別，新增確認機制
                    if (await ui.confirm('是否確認刪除此類別?')) {
                        if ($(this).parent().hasClass('now_color')) { // 如果被刪除的顏色是聚焦顏色(20210715)
                            $('#color_table .table_tr').removeClass('now_color');
                            $('#color_table .table_tr').removeAttr('data-nowcolor');
                            // 顏色改成預設顏色(public 1)
                            let clickcolor = $('#color_public1');
                            let datacolor = clickcolor.find('.color_color').data('color');
                            let datalabel = clickcolor.find('.color_color').data('colorlabel');
                            clickcolor.addClass('now_color');
                            clickcolor.attr('data-nowcolor', datacolor);
                            tools.ColorMode(painterApp, datacolor, datalabel);
                        }

                        let color_id = $(this).prev().prev().prev().find('input')[0].id;
                        let color_label = $(this).prev().prev().prev().find('input')[0].value;
                        deleteCaseColorPrivate(color_id);
                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list(); //David_20210524
                        refresh_Feature_list_Other(); //David_20210524
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526
                    }

                })

                //刪除該類別全部標註
                $('.note_public .t4').unbind("click").bind("click", async function () { //David_20210525
                    let check = await delete_note_alert();
                    if (check) {//David_20210526_刪除按鈕提醒
                        let note_id = $(this).prev().prev().prev().find('input')[0].id;
                        let note_color = $(this).prev().prev().prev().find('input')[0].value;
                        const feature = vectorLayer.getSource().getFeatures();
                        let i = 0;

                        for (i = 0; i < feature.length; i++) {
                            let id = feature[i].getId();
                            let color = feature[i].getProperties().hexCode;

                            if (note_color == color) {
                                vectorSource.removeFeature(feature[i]);

                                _delete = new ol.interaction.Select({
                                    features: feature[i],
                                });

                                map.removeInteraction(_delete);
                            }
                        }

                        sendCase_imm();
                        console.log(5362);
                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list();
                        refresh_Feature_list_Other();
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526

                    }
                })

                //刪除該標註
                $('.note_private .t4').unbind("click").bind("click", async function () { //David_20210525
                    let check = await delete_note_alert()
                    if (check) {//David_20210526_刪除按鈕提醒
                        let note_id = $(this).prev().prev().prev().find('input')[0].id;
                        let note_color = $(this).prev().prev().prev().find('input')[0].value;

                        if (note_id == 'text_0') {
                            note_list_delete_alltext();
                        }
                        else {
                            const feature = vectorLayer.getSource().getFeatures();

                            for (let i = 0; i < feature.length; i++) {
                                let id = feature[i].getId();
                                let color = feature[i].getProperties().hexCode;

                                //alert("id(" + i + "): " + id);
                                //alert("color(" + i + "): " + color);

                                if (note_color == color) {
                                    vectorSource.removeFeature(feature[i]);

                                    _delete = new ol.interaction.Select({
                                        features: feature[i],
                                    });

                                    map.removeInteraction(_delete);
                                }
                            }

                            refresh_color_seletor();
                            refresh_color_list_private();
                            await refresh_Feature_list();
                            refresh_Feature_list_Other();
                            $('#show_all_layer').prop('checked', false); //David_20210526
                            $('#show_all_layer').prop('checked', true); //David_20210526
                        }

                    }
                })

                // 新增private color
                $('#color_add_btn .color_edit_btn').unbind("click").bind("click", async function () {
                    $('.color_select_box').removeClass('d-flex'); // 關閉顏色小視窗
                    let label = $('.t1 input')[0].value;
                    let rgb = $('.t2 button div')[0].style.backgroundColor;
                    if (rgb == 'greenyellow') {
                        warn_alert();
                    } else {
                        let r = rgb.split(',')[0].split('(')[1];
                        let g = rgb.split(',')[1];
                        let b = rgb.split(',')[2].split(')')[0];
                        rgb = "#" + ("0" + parseInt(r, 10).toString(16)).slice(-2) + ("0" + parseInt(g, 10).toString(16)).slice(-2) +
                            ("0" + parseInt(b, 10).toString(16)).slice(-2);
                        let color = rgb;

                        setCaseColorPrivate(label, color);
                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list(); //David_20210524
                        refresh_Feature_list_Other(); //David_20210524
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526
                        document.getElementById("input_color").value = "";
                        document.getElementById("select_new_color_div").style.backgroundColor = "greenyellow";
                    }

                })

                //按下修改才能更動private部分
                $('.color_private .color_edit_btn').unbind("click").bind("click", async function () {
                    $('.color_select_box').removeClass('d-flex')
                    let edit_color_btn = $(this).parent().prev().find('.edit_color');
                    $('.t1 input').not($(this).parent().parent().find('.t1 input')).attr('readonly', 'readonly')
                    $(this).parent().parent().find('.t1 input').toggleAttrVal('readonly', 'readonly', false)

                    if ($(this).text() == "修改") {
                        $(this).text("確認");
                        $('.color_private .color_edit_btn').not($(this)).text("修改")
                        $('.edit_color').not(edit_color_btn).prop('disabled', true);
                        edit_color_btn.prop('disabled', false);

                        edit_color_btn.unbind("click").bind("click", function () {

                            $('.color_select_box').addClass('d-flex');
                            $('.color_select_box').css({
                                'bottom': "0",
                                "top": ""
                            })
                            //自動聚焦在已選顏色上
                            let has_color = $(this).data('color');
                            if (has_color != null) {
                                $('.color_selector').each(function (index, value) {
                                    if ($(this).data('color') != null && $(this).data('color') == has_color) {
                                        $(this).prop('checked', true)
                                    }
                                })
                            } else {
                                $('.color_selector').prop('checked', false)
                            }
                            $('.color_selector').unbind("click").bind("click", function () {
                                let get_color = $(this).data('color');
                                edit_color_btn.attr('data-color', get_color)
                                edit_color_btn.find('div').css('background', get_color)
                            })
                        })
                    } else {
                        $('.color_select_box').removeClass('d-flex')
                        $(this).parent().prev().find('button').prop('disabled', true);
                        $(this).text("修改");
                        let color_id = $(this).parent().prev().prev().find('input')[0].id;
                        let color_label = $(this).parent().prev().prev().find('input')[0].value;

                        updateCaseColorPrivate(color_id, color_label);
                        refresh_color_seletor();
                        refresh_color_list_private();
                        await refresh_Feature_list(); //David_20210524
                        refresh_Feature_list_Other(); //David_20210524
                        $('#show_all_layer').prop('checked', false); //David_20210526
                        $('#show_all_layer').prop('checked', true); //David_20210526
                    }
                })

                $('#select_new_color').unbind("click").bind("click", function () {
                    let edit_color_btn = null;
                    $('.color_private .color_edit_btn').text("修改")
                    $('.edit_color').prop('disabled', true);
                    //$('.t1 input').attr('readonly', 'readonly')
                    $('.color_select_box').toggleClass('d-flex');
                    $('.color_select_box').css({
                        'bottom': "",
                        "top": "0"
                    })
                    //自動聚焦在已選顏色上
                    let has_color = $(this).data('color');
                    if (has_color != null) {
                        $('.color_selector').each(function (index, value) {
                            if ($(this).data('color') != null && $(this).data('color') == has_color) {
                                $(this).prop('checked', true)
                            }
                        })
                    } else {
                        $('.color_selector').prop('checked', false)
                    }
                    $('.color_selector').unbind("click").bind("click", function () {
                        let get_new_color = $(this).data('color');
                        $('#select_new_color div').css('background', get_new_color)
                        $('#select_new_color').attr('data-color', get_new_color)
                        //class"color_selector"類別皆有data-color標籤
                        //   alert("你現在選擇的是"+get_new_color)

                    })
                })

                //目前標註是用哪個顏色(20210715)
                $('#color_table .table_tr:not(.no_hover) .t1').unbind("click").bind("click", function () {
                    let clickcolor = $(this).parent();
                    $('#color_table .table_tr').not(clickcolor).removeClass('now_color');
                    $('#color_table .table_tr').not(clickcolor).removeAttr('data-nowcolor');
                    // let datacolor = $(this).parent().find('.color_color').data('color');
                    // let datalabel = $(this).parent().find('.color_color').data('colorlabel');
                    let datacolor = $(this).parent().find('.color_color').get(0).dataset.color;
                    let datalabel = $(this).parent().find('.color_color').get(0).dataset.colorlabel;
                    clickcolor.addClass('now_color');
                    clickcolor.attr('data-nowcolor', datacolor);
                    tools.ColorMode(painterApp, datacolor, datalabel);
                });

                $('#RectangleMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.RectangleMode(painterApp);
                });

                $('#EllipseMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.EllipseMode(painterApp);
                });

                $('#PolygonMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.PolygonMode(painterApp);
                });

                $('#PencilMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.PencilMode(painterApp);
                });

                $('#TextMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.TextMode(painterApp);
                });

                $('#EraserMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.EraserMode(painterApp);
                });

                $('#MouseMode').bind("click", function () {
                    painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.MouseMode(painterApp);
                });

                $('#ZoomMode').bind("click", function () {
                    //painterApp.onModeChange(this.value);
                    resetInteractions();
                    removeTextListener();
                    tools.ZoomMode();
                });

                //存檔
                $(document).on('click', "#saveCase", function () {
                    sendCase()
                });
            });

            document.documentElement.style.overflowY = 'hidden';

        }

        // 工具
        let tools = {};

        // 滑鼠工具實作
        tools.MouseMode = function (context) {
            if (map) {
                // 圖形編輯
                editAnnotation();
                // 文字編輯
                editTextAnnotation();
            }
        };

        // 縮放工具實作
        tools.ZoomMode = function (context) {
            $("#zoomMsg").toggle();
        };

        // 矩形工具實作
        tools.RectangleMode = function (context) {
            if (map) {
                map = toggleDrawMode(AnnotationShapes.Rectangle);
            }
        };

        // 圓形工具實作
        tools.EllipseMode = function (context) {
            console.log(map);
            if (map) {
                map = toggleDrawMode(AnnotationShapes.Circle);
            }
        };

        // 多邊形工具實作
        tools.PolygonMode = function (context) {
            if (map) {
                map = toggleDrawMode(AnnotationShapes.Polygon);
            }
        };

        // 畫筆工具實作
        tools.PencilMode = function (context) {
            if (map) {
                map = toggleDrawMode(AnnotationShapes.FreeformPolygon);
            }
        };

        // 文字工具實作
        tools.TextMode = function (context) {
            if (map) {
                createTextObj("");
            }
        };

        // 圖形清除工具實作
        tools.EraserMode = function (context) {
            if (map) {
                deleteAnnotation();
            }
        };

        // 圖形存檔工具實作
        tools.saveCaseMode = function (context) {
            sendCase();
        };

        tools.ColorMode = function (context, color, label) {
            context.setColor(color, label)
        };

        // 建立新的 HTML 元素
        function createElement(name, attributes) {
            let node = document.createElement(name);
            if (attributes) {
                for (let attr in attributes)
                    if (attributes.hasOwnProperty(attr))
                        node.setAttribute(attr, attributes[attr]);
            }
            for (let i = 2; i < arguments.length; i++) {
                let child = arguments[i];
                if (typeof child == 'string')
                    child = document.createTextNode(child);
                node.appendChild(child);
            }
            return node;
        }

        // 初始化 APP
        $(async function () {
            initPainterApp($("#painter_app").get(0));
        });
    </script>
</body>

</html>